import e from"cross-fetch";import{PrivateKey as t,encrypt as n,decrypt as o}from"eciesjs";import{EventEmitter2 as i}from"eventemitter2";import{validate as r,v4 as s}from"uuid";import{io as a}from"socket.io-client";function c(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;var u="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function l(){throw new Error("setTimeout has not been defined")}function d(){throw new Error("clearTimeout has not been defined")}var h=l,f=d;function m(e){if(h===setTimeout)return setTimeout(e,0);if((h===l||!h)&&setTimeout)return h=setTimeout,setTimeout(e,0);try{return h(e,0)}catch(t){try{return h.call(null,e,0)}catch(t){return h.call(this,e,0)}}}"function"==typeof u.setTimeout&&(h=setTimeout),"function"==typeof u.clearTimeout&&(f=clearTimeout);var g,p=[],y=!1,v=-1;function E(){y&&g&&(y=!1,g.length?p=g.concat(p):v=-1,p.length&&C())}function C(){if(!y){var e=m(E);y=!0;for(var t=p.length;t;){for(g=p,p=[];++v<t;)g&&g[v].run();v=-1,t=p.length}g=null,y=!1,function(e){if(f===clearTimeout)return clearTimeout(e);if((f===d||!f)&&clearTimeout)return f=clearTimeout,clearTimeout(e);try{return f(e)}catch(t){try{return f.call(null,e)}catch(t){return f.call(this,e)}}}(e)}}function S(e,t){this.fun=e,this.array=t}S.prototype.run=function(){this.fun.apply(null,this.array)};function k(){}var _=k,w=k,x=k,A=k,I=k,R=k,b=k;var K=u.performance||{},T=K.now||K.mozNow||K.msNow||K.oNow||K.webkitNow||function(){return(new Date).getTime()};var N=new Date;var O={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];p.push(new S(e,t)),1!==p.length||y||m(C)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:_,addListener:w,once:x,off:A,removeListener:I,removeAllListeners:R,emit:b,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*T.call(K),n=Math.floor(t),o=Math.floor(t%1*1e9);return e&&(n-=e[0],(o-=e[1])<0&&(n--,o+=1e9)),[n,o]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-N)/1e3}};function D(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var P,L,M={exports:{}};function $(){if(L)return P;L=1;var e=1e3,t=60*e,n=60*t,o=24*n,i=7*o,r=365.25*o;function s(e,t,n,o){var i=t>=1.5*n;return Math.round(e/n)+" "+o+(i?"s":"")}return P=function(a,c){c=c||{};var u=typeof a;if("string"===u&&a.length>0)return function(s){if((s=String(s)).length>100)return;var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(s);if(!a)return;var c=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*r;case"weeks":case"week":case"w":return c*i;case"days":case"day":case"d":return c*o;case"hours":case"hour":case"hrs":case"hr":case"h":return c*n;case"minutes":case"minute":case"mins":case"min":case"m":return c*t;case"seconds":case"second":case"secs":case"sec":case"s":return c*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(a);if("number"===u&&isFinite(a))return c.long?function(i){var r=Math.abs(i);if(r>=o)return s(i,r,o,"day");if(r>=n)return s(i,r,n,"hour");if(r>=t)return s(i,r,t,"minute");if(r>=e)return s(i,r,e,"second");return i+" ms"}(a):function(i){var r=Math.abs(i);if(r>=o)return Math.round(i/o)+"d";if(r>=n)return Math.round(i/n)+"h";if(r>=t)return Math.round(i/t)+"m";if(r>=e)return Math.round(i/e)+"s";return i+"ms"}(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))}}var U=function(e){function t(e){let o,i,r,s=null;function a(...e){if(!a.enabled)return;const n=a,i=Number(new Date),r=i-(o||i);n.diff=r,n.prev=o,n.curr=i,o=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((o,i)=>{if("%%"===o)return"%";s++;const r=t.formatters[i];if("function"==typeof r){const t=e[s];o=r.call(n,t),e.splice(s,1),s--}return o})),t.formatArgs.call(n,e);(n.log||t.log).apply(n,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=n,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==s?s:(i!==t.namespaces&&(i=t.namespaces,r=t.enabled(e)),r),set:e=>{s=e}}),"function"==typeof t.init&&t.init(a),a}function n(e,n){const o=t(this.namespace+(void 0===n?":":n)+e);return o.log=this.log,o}function o(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(o),...t.skips.map(o).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let n;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const o=("string"==typeof e?e:"").split(/[\s,]+/),i=o.length;for(n=0;n<i;n++)o[n]&&("-"===(e=o[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let n,o;for(n=0,o=t.skips.length;n<o;n++)if(t.skips[n].test(e))return!1;for(n=0,o=t.names.length;n<o;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=$(),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((n=>{t[n]=e[n]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t};!function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let o=0,i=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(o++,"%c"===e&&(i=o))})),t.splice(i,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==O&&"env"in O&&(e=O.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=U(t);const{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(M,M.exports);var H=D(M.exports);const Y=H("KeyExchange:Layer"),F=H("SocketService:Layer"),j=H("Ecies:Layer"),B=H("RemoteCommunication:Layer");Y.color="##95c44e",F.color="#f638d7",j.color="#465b9c",B.color="#47a2be";const z={KeyExchange:Y,SocketService:F,Ecies:j,RemoteCommunication:B};let G,V=[],W=[];function J(t){return c(this,void 0,void 0,(function*(){if(!G||!t)return;!function(){const e=W;W=V,V=e}();const n=G.endsWith("/")?`${G}debug`:`${G}/debug`,o=Object.assign({},t);if(delete o.params,t.params)for(const[e,n]of Object.entries(t.params))o[e]=n;const i=JSON.stringify(o);z.RemoteCommunication(`[sendBufferedEvents] Sending ${V.length} analytics events to ${n}`);try{const t=yield e(n,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:i}),o=yield t.text();z.RemoteCommunication(`[sendBufferedEvents] Response: ${o}`),V.length=0}catch(e){console.warn("Error sending analytics",e)}}))}const Z=(e,t)=>c(void 0,void 0,void 0,(function*(){var n;G=t,n=e,W.push(n),J(e).catch((()=>{}))}));var X=[],Q=[],q="undefined"!=typeof Uint8Array?Uint8Array:Array,ee=!1;function te(){ee=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)X[t]=e[t],Q[e.charCodeAt(t)]=t;Q["-".charCodeAt(0)]=62,Q["_".charCodeAt(0)]=63}function ne(e,t,n){for(var o,i,r=[],s=t;s<n;s+=3)o=(e[s]<<16)+(e[s+1]<<8)+e[s+2],r.push(X[(i=o)>>18&63]+X[i>>12&63]+X[i>>6&63]+X[63&i]);return r.join("")}function oe(e){var t;ee||te();for(var n=e.length,o=n%3,i="",r=[],s=16383,a=0,c=n-o;a<c;a+=s)r.push(ne(e,a,a+s>c?c:a+s));return 1===o?(t=e[n-1],i+=X[t>>2],i+=X[t<<4&63],i+="=="):2===o&&(t=(e[n-2]<<8)+e[n-1],i+=X[t>>10],i+=X[t>>4&63],i+=X[t<<2&63],i+="="),r.push(i),r.join("")}function ie(e,t,n,o,i){var r,s,a=8*i-o-1,c=(1<<a)-1,u=c>>1,l=-7,d=n?i-1:0,h=n?-1:1,f=e[t+d];for(d+=h,r=f&(1<<-l)-1,f>>=-l,l+=a;l>0;r=256*r+e[t+d],d+=h,l-=8);for(s=r&(1<<-l)-1,r>>=-l,l+=o;l>0;s=256*s+e[t+d],d+=h,l-=8);if(0===r)r=1-u;else{if(r===c)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,o),r-=u}return(f?-1:1)*s*Math.pow(2,r-o)}function re(e,t,n,o,i,r){var s,a,c,u=8*r-i-1,l=(1<<u)-1,d=l>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,f=o?0:r-1,m=o?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+d>=1?h/c:h*Math.pow(2,1-d))*c>=2&&(s++,c/=2),s+d>=l?(a=0,s=l):s+d>=1?(a=(t*c-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[n+f]=255&a,f+=m,a/=256,i-=8);for(s=s<<i|a,u+=i;u>0;e[n+f]=255&s,f+=m,s/=256,u-=8);e[n+f-m]|=128*g}var se={}.toString,ae=Array.isArray||function(e){return"[object Array]"==se.call(e)};function ce(){return le.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function ue(e,t){if(ce()<t)throw new RangeError("Invalid typed array length");return le.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=le.prototype:(null===e&&(e=new le(t)),e.length=t),e}function le(e,t,n){if(!(le.TYPED_ARRAY_SUPPORT||this instanceof le))return new le(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return fe(this,e)}return de(this,e,t,n)}function de(e,t,n,o){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,o){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(o||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===o?new Uint8Array(t):void 0===o?new Uint8Array(t,n):new Uint8Array(t,n,o);le.TYPED_ARRAY_SUPPORT?(e=t).__proto__=le.prototype:e=me(e,t);return e}(e,t,n,o):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!le.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var o=0|ye(t,n);e=ue(e,o);var i=e.write(t,n);i!==o&&(e=e.slice(0,i));return e}(e,t,n):function(e,t){if(pe(t)){var n=0|ge(t.length);return 0===(e=ue(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(o=t.length)!=o?ue(e,0):me(e,t);if("Buffer"===t.type&&ae(t.data))return me(e,t.data)}var o;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function he(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function fe(e,t){if(he(t),e=ue(e,t<0?0:0|ge(t)),!le.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function me(e,t){var n=t.length<0?0:0|ge(t.length);e=ue(e,n);for(var o=0;o<n;o+=1)e[o]=255&t[o];return e}function ge(e){if(e>=ce())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+ce().toString(16)+" bytes");return 0|e}function pe(e){return!(null==e||!e._isBuffer)}function ye(e,t){if(pe(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var o=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return Be(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return ze(e).length;default:if(o)return Be(e).length;t=(""+t).toLowerCase(),o=!0}}function ve(e,t,n){var o=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return Oe(this,t,n);case"utf8":case"utf-8":return be(this,t,n);case"ascii":return Te(this,t,n);case"latin1":case"binary":return Ne(this,t,n);case"base64":return Re(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return De(this,t,n);default:if(o)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),o=!0}}function Ee(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function Ce(e,t,n,o,i){if(0===e.length)return-1;if("string"==typeof n?(o=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=le.from(t,o)),pe(t))return 0===t.length?-1:Se(e,t,n,o,i);if("number"==typeof t)return t&=255,le.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):Se(e,[t],n,o,i);throw new TypeError("val must be string, number or Buffer")}function Se(e,t,n,o,i){var r,s=1,a=e.length,c=t.length;if(void 0!==o&&("ucs2"===(o=String(o).toLowerCase())||"ucs-2"===o||"utf16le"===o||"utf-16le"===o)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var l=-1;for(r=n;r<a;r++)if(u(e,r)===u(t,-1===l?0:r-l)){if(-1===l&&(l=r),r-l+1===c)return l*s}else-1!==l&&(r-=r-l),l=-1}else for(n+c>a&&(n=a-c),r=n;r>=0;r--){for(var d=!0,h=0;h<c;h++)if(u(e,r+h)!==u(t,h)){d=!1;break}if(d)return r}return-1}function ke(e,t,n,o){n=Number(n)||0;var i=e.length-n;o?(o=Number(o))>i&&(o=i):o=i;var r=t.length;if(r%2!=0)throw new TypeError("Invalid hex string");o>r/2&&(o=r/2);for(var s=0;s<o;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function _e(e,t,n,o){return Ge(Be(t,e.length-n),e,n,o)}function we(e,t,n,o){return Ge(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,o)}function xe(e,t,n,o){return we(e,t,n,o)}function Ae(e,t,n,o){return Ge(ze(t),e,n,o)}function Ie(e,t,n,o){return Ge(function(e,t){for(var n,o,i,r=[],s=0;s<e.length&&!((t-=2)<0);++s)o=(n=e.charCodeAt(s))>>8,i=n%256,r.push(i),r.push(o);return r}(t,e.length-n),e,n,o)}function Re(e,t,n){return 0===t&&n===e.length?oe(e):oe(e.slice(t,n))}function be(e,t,n){n=Math.min(e.length,n);for(var o=[],i=t;i<n;){var r,s,a,c,u=e[i],l=null,d=u>239?4:u>223?3:u>191?2:1;if(i+d<=n)switch(d){case 1:u<128&&(l=u);break;case 2:128==(192&(r=e[i+1]))&&(c=(31&u)<<6|63&r)>127&&(l=c);break;case 3:r=e[i+1],s=e[i+2],128==(192&r)&&128==(192&s)&&(c=(15&u)<<12|(63&r)<<6|63&s)>2047&&(c<55296||c>57343)&&(l=c);break;case 4:r=e[i+1],s=e[i+2],a=e[i+3],128==(192&r)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&r)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(l=c)}null===l?(l=65533,d=1):l>65535&&(l-=65536,o.push(l>>>10&1023|55296),l=56320|1023&l),o.push(l),i+=d}return function(e){var t=e.length;if(t<=Ke)return String.fromCharCode.apply(String,e);var n="",o=0;for(;o<t;)n+=String.fromCharCode.apply(String,e.slice(o,o+=Ke));return n}(o)}le.TYPED_ARRAY_SUPPORT=void 0===u.TYPED_ARRAY_SUPPORT||u.TYPED_ARRAY_SUPPORT,ce(),le.poolSize=8192,le._augment=function(e){return e.__proto__=le.prototype,e},le.from=function(e,t,n){return de(null,e,t,n)},le.TYPED_ARRAY_SUPPORT&&(le.prototype.__proto__=Uint8Array.prototype,le.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&le[Symbol.species]),le.alloc=function(e,t,n){return function(e,t,n,o){return he(t),t<=0?ue(e,t):void 0!==n?"string"==typeof o?ue(e,t).fill(n,o):ue(e,t).fill(n):ue(e,t)}(null,e,t,n)},le.allocUnsafe=function(e){return fe(null,e)},le.allocUnsafeSlow=function(e){return fe(null,e)},le.isBuffer=function(e){return null!=e&&(!!e._isBuffer||Ve(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&Ve(e.slice(0,0))}(e))},le.compare=function(e,t){if(!pe(e)||!pe(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,o=t.length,i=0,r=Math.min(n,o);i<r;++i)if(e[i]!==t[i]){n=e[i],o=t[i];break}return n<o?-1:o<n?1:0},le.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},le.concat=function(e,t){if(!ae(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return le.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var o=le.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var r=e[n];if(!pe(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(o,i),i+=r.length}return o},le.byteLength=ye,le.prototype._isBuffer=!0,le.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)Ee(this,t,t+1);return this},le.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)Ee(this,t,t+3),Ee(this,t+1,t+2);return this},le.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)Ee(this,t,t+7),Ee(this,t+1,t+6),Ee(this,t+2,t+5),Ee(this,t+3,t+4);return this},le.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?be(this,0,e):ve.apply(this,arguments)},le.prototype.equals=function(e){if(!pe(e))throw new TypeError("Argument must be a Buffer");return this===e||0===le.compare(this,e)},le.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},le.prototype.compare=function(e,t,n,o,i){if(!pe(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===o&&(o=0),void 0===i&&(i=this.length),t<0||n>e.length||o<0||i>this.length)throw new RangeError("out of range index");if(o>=i&&t>=n)return 0;if(o>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var r=(i>>>=0)-(o>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(r,s),c=this.slice(o,i),u=e.slice(t,n),l=0;l<a;++l)if(c[l]!==u[l]){r=c[l],s=u[l];break}return r<s?-1:s<r?1:0},le.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},le.prototype.indexOf=function(e,t,n){return Ce(this,e,t,n,!0)},le.prototype.lastIndexOf=function(e,t,n){return Ce(this,e,t,n,!1)},le.prototype.write=function(e,t,n,o){if(void 0===t)o="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)o=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===o&&(o="utf8")):(o=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");o||(o="utf8");for(var r=!1;;)switch(o){case"hex":return ke(this,e,t,n);case"utf8":case"utf-8":return _e(this,e,t,n);case"ascii":return we(this,e,t,n);case"latin1":case"binary":return xe(this,e,t,n);case"base64":return Ae(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ie(this,e,t,n);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(""+o).toLowerCase(),r=!0}},le.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Ke=4096;function Te(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(127&e[i]);return o}function Ne(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(e[i]);return o}function Oe(e,t,n){var o=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>o)&&(n=o);for(var i="",r=t;r<n;++r)i+=je(e[r]);return i}function De(e,t,n){for(var o=e.slice(t,n),i="",r=0;r<o.length;r+=2)i+=String.fromCharCode(o[r]+256*o[r+1]);return i}function Pe(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function Le(e,t,n,o,i,r){if(!pe(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<r)throw new RangeError('"value" argument is out of bounds');if(n+o>e.length)throw new RangeError("Index out of range")}function Me(e,t,n,o){t<0&&(t=65535+t+1);for(var i=0,r=Math.min(e.length-n,2);i<r;++i)e[n+i]=(t&255<<8*(o?i:1-i))>>>8*(o?i:1-i)}function $e(e,t,n,o){t<0&&(t=4294967295+t+1);for(var i=0,r=Math.min(e.length-n,4);i<r;++i)e[n+i]=t>>>8*(o?i:3-i)&255}function Ue(e,t,n,o,i,r){if(n+o>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function He(e,t,n,o,i){return i||Ue(e,0,n,4),re(e,t,n,o,23,4),n+4}function Ye(e,t,n,o,i){return i||Ue(e,0,n,8),re(e,t,n,o,52,8),n+8}le.prototype.slice=function(e,t){var n,o=this.length;if((e=~~e)<0?(e+=o)<0&&(e=0):e>o&&(e=o),(t=void 0===t?o:~~t)<0?(t+=o)<0&&(t=0):t>o&&(t=o),t<e&&(t=e),le.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=le.prototype;else{var i=t-e;n=new le(i,void 0);for(var r=0;r<i;++r)n[r]=this[r+e]}return n},le.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||Pe(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o},le.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||Pe(e,t,this.length);for(var o=this[e+--t],i=1;t>0&&(i*=256);)o+=this[e+--t]*i;return o},le.prototype.readUInt8=function(e,t){return t||Pe(e,1,this.length),this[e]},le.prototype.readUInt16LE=function(e,t){return t||Pe(e,2,this.length),this[e]|this[e+1]<<8},le.prototype.readUInt16BE=function(e,t){return t||Pe(e,2,this.length),this[e]<<8|this[e+1]},le.prototype.readUInt32LE=function(e,t){return t||Pe(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},le.prototype.readUInt32BE=function(e,t){return t||Pe(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},le.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||Pe(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},le.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||Pe(e,t,this.length);for(var o=t,i=1,r=this[e+--o];o>0&&(i*=256);)r+=this[e+--o]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},le.prototype.readInt8=function(e,t){return t||Pe(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},le.prototype.readInt16LE=function(e,t){t||Pe(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},le.prototype.readInt16BE=function(e,t){t||Pe(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},le.prototype.readInt32LE=function(e,t){return t||Pe(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},le.prototype.readInt32BE=function(e,t){return t||Pe(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},le.prototype.readFloatLE=function(e,t){return t||Pe(e,4,this.length),ie(this,e,!0,23,4)},le.prototype.readFloatBE=function(e,t){return t||Pe(e,4,this.length),ie(this,e,!1,23,4)},le.prototype.readDoubleLE=function(e,t){return t||Pe(e,8,this.length),ie(this,e,!0,52,8)},le.prototype.readDoubleBE=function(e,t){return t||Pe(e,8,this.length),ie(this,e,!1,52,8)},le.prototype.writeUIntLE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||Le(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,r=0;for(this[t]=255&e;++r<n&&(i*=256);)this[t+r]=e/i&255;return t+n},le.prototype.writeUIntBE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||Le(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,r=1;for(this[t+i]=255&e;--i>=0&&(r*=256);)this[t+i]=e/r&255;return t+n},le.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,1,255,0),le.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},le.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,2,65535,0),le.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Me(this,e,t,!0),t+2},le.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,2,65535,0),le.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Me(this,e,t,!1),t+2},le.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,4,4294967295,0),le.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):$e(this,e,t,!0),t+4},le.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,4,4294967295,0),le.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):$e(this,e,t,!1),t+4},le.prototype.writeIntLE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);Le(this,e,t,n,i-1,-i)}var r=0,s=1,a=0;for(this[t]=255&e;++r<n&&(s*=256);)e<0&&0===a&&0!==this[t+r-1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},le.prototype.writeIntBE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);Le(this,e,t,n,i-1,-i)}var r=n-1,s=1,a=0;for(this[t+r]=255&e;--r>=0&&(s*=256);)e<0&&0===a&&0!==this[t+r+1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},le.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,1,127,-128),le.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},le.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,2,32767,-32768),le.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Me(this,e,t,!0),t+2},le.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,2,32767,-32768),le.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Me(this,e,t,!1),t+2},le.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,4,2147483647,-2147483648),le.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):$e(this,e,t,!0),t+4},le.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||Le(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),le.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):$e(this,e,t,!1),t+4},le.prototype.writeFloatLE=function(e,t,n){return He(this,e,t,!0,n)},le.prototype.writeFloatBE=function(e,t,n){return He(this,e,t,!1,n)},le.prototype.writeDoubleLE=function(e,t,n){return Ye(this,e,t,!0,n)},le.prototype.writeDoubleBE=function(e,t,n){return Ye(this,e,t,!1,n)},le.prototype.copy=function(e,t,n,o){if(n||(n=0),o||0===o||(o=this.length),t>=e.length&&(t=e.length),t||(t=0),o>0&&o<n&&(o=n),o===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(o<0)throw new RangeError("sourceEnd out of bounds");o>this.length&&(o=this.length),e.length-t<o-n&&(o=e.length-t+n);var i,r=o-n;if(this===e&&n<t&&t<o)for(i=r-1;i>=0;--i)e[i+t]=this[i+n];else if(r<1e3||!le.TYPED_ARRAY_SUPPORT)for(i=0;i<r;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+r),t);return r},le.prototype.fill=function(e,t,n,o){if("string"==typeof e){if("string"==typeof t?(o=t,t=0,n=this.length):"string"==typeof n&&(o=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==o&&"string"!=typeof o)throw new TypeError("encoding must be a string");if("string"==typeof o&&!le.isEncoding(o))throw new TypeError("Unknown encoding: "+o)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var r;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(r=t;r<n;++r)this[r]=e;else{var s=pe(e)?e:Be(new le(e,o).toString()),a=s.length;for(r=0;r<n-t;++r)this[r+t]=s[r%a]}return this};var Fe=/[^+\/0-9A-Za-z-_]/g;function je(e){return e<16?"0"+e.toString(16):e.toString(16)}function Be(e,t){var n;t=t||1/0;for(var o=e.length,i=null,r=[],s=0;s<o;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&r.push(239,191,189);continue}if(s+1===o){(t-=3)>-1&&r.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&r.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&r.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;r.push(n)}else if(n<2048){if((t-=2)<0)break;r.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;r.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return r}function ze(e){return function(e){var t,n,o,i,r,s;ee||te();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");r="="===e[a-2]?2:"="===e[a-1]?1:0,s=new q(3*a/4-r),o=r>0?a-4:a;var c=0;for(t=0,n=0;t<o;t+=4,n+=3)i=Q[e.charCodeAt(t)]<<18|Q[e.charCodeAt(t+1)]<<12|Q[e.charCodeAt(t+2)]<<6|Q[e.charCodeAt(t+3)],s[c++]=i>>16&255,s[c++]=i>>8&255,s[c++]=255&i;return 2===r?(i=Q[e.charCodeAt(t)]<<2|Q[e.charCodeAt(t+1)]>>4,s[c++]=255&i):1===r&&(i=Q[e.charCodeAt(t)]<<10|Q[e.charCodeAt(t+1)]<<4|Q[e.charCodeAt(t+2)]>>2,s[c++]=i>>8&255,s[c++]=255&i),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(Fe,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Ge(e,t,n,o){for(var i=0;i<o&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}function Ve(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}class We{constructor(e){this.enabled=!0,(null==e?void 0:e.debug)&&H.enable("Ecies:Layer"),(null==e?void 0:e.pkey)?this.ecies=t.fromHex(e.pkey):this.ecies=new t,z.Ecies("[ECIES constructor()] initialized secret: ",this.ecies.toHex()),z.Ecies("[ECIES constructor()] initialized public: ",this.ecies.publicKey.toHex()),z.Ecies("[ECIES constructor()] init with",this)}generateECIES(){this.ecies=new t}getPublicKey(){return this.ecies.publicKey.toHex()}encrypt(e,t){let o=e;if(this.enabled)try{z.Ecies("[ECIES: encrypt()] using otherPublicKey",t);const i=le.from(e),r=n(t,i);o=le.from(r).toString("base64")}catch(n){throw z.Ecies("[ECIES: encrypt()] error encrypt:",n),z.Ecies("[ECIES: encrypt()] private: ",this.ecies.toHex()),z.Ecies("[ECIES: encrypt()] data: ",e),z.Ecies("[ECIES: encrypt()] otherkey: ",t),n}return o}decrypt(e){let t=e;if(this.enabled)try{z.Ecies("[ECIES: decrypt()] using privateKey",this.ecies.toHex());const n=le.from(e.toString(),"base64");t=o(this.ecies.toHex(),n).toString()}catch(t){throw z.Ecies("[ECIES: decrypt()] error decrypt",t),z.Ecies("[ECIES: decrypt()] private: ",this.ecies.toHex()),z.Ecies("[ECIES: decrypt()] encryptedData: ",e),t}return t}getKeyInfo(){return{private:this.ecies.toHex(),public:this.ecies.publicKey.toHex()}}toString(){z.Ecies("[ECIES: toString()]",this.getKeyInfo())}}var Je={name:"@metamask/sdk-communication-layer",version:"0.18.5",description:"",homepage:"https://github.com/MetaMask/metamask-sdk#readme",bugs:{url:"https://github.com/MetaMask/metamask-sdk/issues"},repository:{type:"git",url:"https://github.com/MetaMask/metamask-sdk.git",directory:"packages/sdk-communication-layer"},main:"dist/node/cjs/metamask-sdk-communication-layer.js",unpkg:"dist/browser/umd/metamask-sdk-communication-layer.js",module:"dist/node/es/metamask-sdk-communication-layer.js",browser:"dist/browser/es/metamask-sdk-communication-layer.js","react-native":"dist/react-native/es/metamask-sdk-communication-layer.js",types:"dist/browser/es/src/index.d.ts",files:["/dist"],scripts:{build:"rimraf dist && rollup -c --bundleConfigAsCjs","build:tsc":"tsc","build:dev":"rimraf dist && NODE_ENV=dev rollup -c --bundleConfigAsCjs","build:post-tsc":"echo 'N/A'","build:pre-tsc":"echo 'N/A'",size:"size-limit",clean:"rimraf ./dist",lint:"yarn lint:eslint && yarn lint:misc --check","lint:changelog":"../../scripts/validate-changelog.sh @metamask/sdk-communication-layer","lint:eslint":"eslint . --cache --ext js,ts","lint:fix":"yarn lint:eslint --fix && yarn lint:misc --write","lint:misc":"prettier '**/*.json' '**/*.md' '!CHANGELOG.md' --ignore-path ../../.gitignore","prepare-manifest:preview":"../../scripts/prepare-preview-manifest.sh","publish:preview":"yarn npm publish --tag preview",prepack:"../../scripts/prepack.sh",reset:"yarn clean && rimraf ./node_modules/",test:"jest","test:coverage":"jest --coverage","test:ci":"jest --coverage --passWithNoTests --setupFilesAfterEnv ./jest-preload.js","test:dev":"jest",watch:"rollup -c --bundleConfigAsCjs -w"},dependencies:{bufferutil:"^4.0.8","date-fns":"^2.29.3",debug:"^4.3.4","utf-8-validate":"^6.0.3",uuid:"^8.3.2"},devDependencies:{"@jest/globals":"^29.3.1","@lavamoat/allow-scripts":"^2.3.1","@metamask/auto-changelog":"3.1.0","@metamask/eslint-config":"^6.0.0","@metamask/eslint-config-nodejs":"^6.0.0","@metamask/eslint-config-typescript":"^6.0.0","@rollup/plugin-commonjs":"^25.0.0","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.2","@rollup/plugin-terser":"^0.4.1","@size-limit/preset-big-lib":"^11.0.2","@types/jest":"^29.2.4","@types/node":"^20.1.3","@types/uuid":"^9.0.0","@typescript-eslint/eslint-plugin":"^4.26.0","@typescript-eslint/parser":"^4.26.0","cross-fetch":"^3.1.5",eciesjs:"^0.3.16",eslint:"^7.30.0","eslint-config-prettier":"^8.3.0","eslint-plugin-import":"^2.23.4","eslint-plugin-jest":"^24.4.0","eslint-plugin-jsdoc":"^36.1.0","eslint-plugin-node":"^11.1.0","eslint-plugin-prettier":"^3.4.0",eventemitter2:"^6.4.7",jest:"^29.3.1",prettier:"^2.3.0",rimraf:"^3.0.2",rollup:"^3.21.7","rollup-plugin-jscc":"^2.0.0","rollup-plugin-natives":"^0.7.5","rollup-plugin-node-builtins":"^2.1.2","rollup-plugin-node-globals":"^1.4.0","rollup-plugin-peer-deps-external":"^2.2.4","rollup-plugin-sizes":"^1.0.6","rollup-plugin-typescript2":"^0.31.2","rollup-plugin-visualizer":"^5.9.2","size-limit":"^11.0.2","socket.io-client":"^4.5.1","stream-browserify":"^3.0.0","ts-jest":"^29.0.3","ts-node":"^10.9.1",typescript:"^4.3.2"},peerDependencies:{"cross-fetch":"^3.1.5",eciesjs:"^0.3.16",eventemitter2:"^6.4.7","readable-stream":"^3.6.2","socket.io-client":"^4.5.1"},publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},lavamoat:{allowScripts:{"@lavamoat/preinstall-always-fail":!1,canvas:!0,"eciesjs>secp256k1":!1,"socket.io-client>engine.io-client>ws>bufferutil":!1,"socket.io-client>engine.io-client>ws>utf-8-validate":!1,bufferutil:!1,"utf-8-validate":!1}}};const Ze="https://metamask-sdk.api.cx.metamask.io/",Xe=["websocket"],Qe=6048e5,qe={METAMASK_GETPROVIDERSTATE:"metamask_getProviderState",ETH_REQUESTACCOUNTS:"eth_requestAccounts"};function et(e){const{context:t}=e;z.RemoteCommunication(`[RemoteCommunication: clean()] context=${t}`),e.channelConfig=void 0,e.ready=!1,e.originatorConnectStarted=!1}var tt,nt,ot,it,rt;!function(e){e.DISCONNECTED="disconnected",e.WAITING="waiting",e.TIMEOUT="timeout",e.LINKED="linked",e.PAUSED="paused",e.TERMINATED="terminated"}(tt||(tt={})),function(e){e.KEY_INFO="key_info",e.SERVICE_STATUS="service_status",e.PROVIDER_UPDATE="provider_update",e.RPC_UPDATE="rpc_update",e.KEYS_EXCHANGED="keys_exchanged",e.JOIN_CHANNEL="join_channel",e.CHANNEL_CREATED="channel_created",e.CLIENTS_CONNECTED="clients_connected",e.CLIENTS_DISCONNECTED="clients_disconnected",e.CLIENTS_WAITING="clients_waiting",e.CLIENTS_READY="clients_ready",e.SOCKET_DISCONNECTED="socket_disconnected",e.SOCKET_RECONNECT="socket_reconnect",e.OTP="otp",e.SDK_RPC_CALL="sdk_rpc_call",e.AUTHORIZED="authorized",e.CONNECTION_STATUS="connection_status",e.MESSAGE="message",e.TERMINATE="terminate"}(nt||(nt={})),function(e){e.KEY_EXCHANGE="key_exchange"}(ot||(ot={})),function(e){e.KEY_HANDSHAKE_START="key_handshake_start",e.KEY_HANDSHAKE_CHECK="key_handshake_check",e.KEY_HANDSHAKE_SYN="key_handshake_SYN",e.KEY_HANDSHAKE_SYNACK="key_handshake_SYNACK",e.KEY_HANDSHAKE_ACK="key_handshake_ACK",e.KEY_HANDSHAKE_NONE="none"}(it||(it={}));class st extends i{constructor({communicationLayer:e,otherPublicKey:t,context:n,ecies:o,logging:i}){super(),this.keysExchanged=!1,this.step=it.KEY_HANDSHAKE_NONE,this.debug=!1,this.context=n,this.myECIES=new We(Object.assign(Object.assign({},o),{debug:null==i?void 0:i.eciesLayer})),this.communicationLayer=e,this.myPublicKey=this.myECIES.getPublicKey(),this.debug=!0===(null==i?void 0:i.keyExchangeLayer),(null==i?void 0:i.keyExchangeLayer)&&H.enable("KeyExchange:Layer"),t&&this.setOtherPublicKey(t),this.communicationLayer.on(ot.KEY_EXCHANGE,this.onKeyExchangeMessage.bind(this))}onKeyExchangeMessage(e){z.KeyExchange(`[KeyExchange: onKeyExchangeMessage()] context=${this.context} keysExchanged=${this.keysExchanged}`,e);const{message:t}=e;this.keysExchanged&&z.KeyExchange(`[KeyExchange: onKeyExchangeMessage()] context=${this.context} received handshake while already exchanged. step=${this.step} otherPubKey=${this.otherPublicKey}`),this.emit(nt.KEY_INFO,t.type),t.type===it.KEY_HANDSHAKE_SYN?(this.checkStep([it.KEY_HANDSHAKE_NONE,it.KEY_HANDSHAKE_ACK]),z.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_SYN",t),t.pubkey&&this.setOtherPublicKey(t.pubkey),this.communicationLayer.sendMessage({type:it.KEY_HANDSHAKE_SYNACK,pubkey:this.myPublicKey}),this.setStep(it.KEY_HANDSHAKE_ACK)):t.type===it.KEY_HANDSHAKE_SYNACK?(this.checkStep([it.KEY_HANDSHAKE_SYNACK,it.KEY_HANDSHAKE_ACK,it.KEY_HANDSHAKE_NONE]),z.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_SYNACK"),t.pubkey&&this.setOtherPublicKey(t.pubkey),this.communicationLayer.sendMessage({type:it.KEY_HANDSHAKE_ACK}),this.keysExchanged=!0,this.setStep(it.KEY_HANDSHAKE_ACK),this.emit(nt.KEYS_EXCHANGED)):t.type===it.KEY_HANDSHAKE_ACK&&(z.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_ACK set keysExchanged to true!"),this.checkStep([it.KEY_HANDSHAKE_ACK,it.KEY_HANDSHAKE_NONE]),this.keysExchanged=!0,this.setStep(it.KEY_HANDSHAKE_ACK),this.emit(nt.KEYS_EXCHANGED))}resetKeys(e){this.clean(),this.myECIES=new We(e)}clean(){z.KeyExchange(`[KeyExchange: clean()] context=${this.context} reset handshake state`),this.setStep(it.KEY_HANDSHAKE_NONE),this.emit(nt.KEY_INFO,this.step),this.keysExchanged=!1}start({isOriginator:e,force:t}){z.KeyExchange(`[KeyExchange: start()] context=${this.context} isOriginator=${e} step=${this.step} force=${t} keysExchanged=${this.keysExchanged}`),e?!(this.keysExchanged||this.step!==it.KEY_HANDSHAKE_NONE&&this.step!==it.KEY_HANDSHAKE_SYNACK)||t?(z.KeyExchange(`[KeyExchange: start()] context=${this.context} -- start key exchange (force=${t}) -- step=${this.step}`,this.step),this.clean(),this.setStep(it.KEY_HANDSHAKE_SYNACK),this.communicationLayer.sendMessage({type:it.KEY_HANDSHAKE_SYN,pubkey:this.myPublicKey})):z.KeyExchange(`[KeyExchange: start()] context=${this.context} -- key exchange already ${this.keysExchanged?"done":"in progress"} -- aborted.`,this.step):this.keysExchanged&&!0!==t?z.KeyExchange("[KeyExchange: start()] don't send KEY_HANDSHAKE_START -- exchange already done."):(this.communicationLayer.sendMessage({type:it.KEY_HANDSHAKE_START}),this.clean())}setStep(e){this.step=e,this.emit(nt.KEY_INFO,e)}checkStep(e){e.length>0&&-1===e.indexOf(this.step.toString())&&console.warn(`[KeyExchange: checkStep()]  Wrong Step "${this.step}" not within ${e}`)}setKeysExchanged(e){this.keysExchanged=e}areKeysExchanged(){return this.keysExchanged}getMyPublicKey(){return this.myPublicKey}getOtherPublicKey(){return this.otherPublicKey}setOtherPublicKey(e){z.KeyExchange("[KeyExchange: setOtherPubKey()]",e),this.otherPublicKey=e}encryptMessage(e){if(!this.otherPublicKey)throw new Error("encryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.encrypt(e,this.otherPublicKey)}decryptMessage(e){if(!this.otherPublicKey)throw new Error("decryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.decrypt(e)}getKeyInfo(){return{ecies:Object.assign(Object.assign({},this.myECIES.getKeyInfo()),{otherPubKey:this.otherPublicKey}),step:this.step,keysExchanged:this.areKeysExchanged()}}toString(){const e={keyInfo:this.getKeyInfo(),keysExchanged:this.keysExchanged,step:this.step};return JSON.stringify(e)}}!function(e){e.TERMINATE="terminate",e.ANSWER="answer",e.OFFER="offer",e.CANDIDATE="candidate",e.JSONRPC="jsonrpc",e.WALLET_INFO="wallet_info",e.ORIGINATOR_INFO="originator_info",e.PAUSE="pause",e.OTP="otp",e.AUTHORIZED="authorized",e.PING="ping",e.READY="ready"}(rt||(rt={}));const at=e=>new Promise((t=>{setTimeout(t,e)})),ct=(e,t,n=200)=>c(void 0,void 0,void 0,(function*(){let o;const i=Date.now();let r=!1;for(;!r;){if(r=Date.now()-i>3e5,o=t[e],void 0!==o.elapsedTime)return o;yield at(n)}throw new Error(`RPC ${e} timed out`)})),ut=({rpcId:e,instance:t})=>c(void 0,void 0,void 0,(function*(){for(;t.state.lastRpcId===e||void 0===t.state.lastRpcId;)yield at(200);return t.state.lastRpcId})),lt=e=>c(void 0,void 0,void 0,(function*(){var t,n,o,i,r;return z.SocketService(`[SocketService: reconnectSocket()] instance.state.socket?.connected=${null===(t=e.state.socket)||void 0===t?void 0:t.connected} trying to reconnect after socketio disconnection`,e),yield at(200),(null===(n=e.state.socket)||void 0===n?void 0:n.connected)||(e.state.resumed=!0,null===(o=e.state.socket)||void 0===o||o.connect(),e.emit(nt.SOCKET_RECONNECT),null===(i=e.state.socket)||void 0===i||i.emit(nt.JOIN_CHANNEL,e.state.channelId,`${e.state.context}connect_again`)),yield at(100),null===(r=e.state.socket)||void 0===r?void 0:r.connected}));function dt(e){return t=>{z.SocketService(`[SocketService: handleDisconnect()] on 'disconnect' manualDisconnect=${e.state.manualDisconnect}`,t),e.state.manualDisconnect||(e.emit(nt.SOCKET_DISCONNECTED),function(e){"undefined"!=typeof window&&"undefined"!=typeof document&&(z.SocketService(`[SocketService: checkFocusAndReconnect()] hasFocus=${document.hasFocus()}`,e),document.hasFocus()?lt(e).then((t=>{z.SocketService(`SocketService::checkFocus reconnectSocket success=${t}`,e)})).catch((e=>{console.error("SocketService::checkFocus Error reconnecting socket",e)})):window.addEventListener("focus",(()=>{lt(e).catch((e=>{console.error("SocketService::checkFocus Error reconnecting socket",e)}))}),{once:!0}))}(e))}}var ht;!function(e){e.REQUEST="sdk_connect_request_started",e.REQUEST_MOBILE="sdk_connect_request_started_mobile",e.RECONNECT="sdk_reconnect_request_started",e.CONNECTED="sdk_connection_established",e.CONNECTED_MOBILE="sdk_connection_established_mobile",e.AUTHORIZED="sdk_connection_authorized",e.REJECTED="sdk_connection_rejected",e.TERMINATED="sdk_connection_terminated",e.DISCONNECTED="sdk_disconnected",e.SDK_USE_EXTENSION="sdk_use_extension",e.SDK_RPC_REQUEST="sdk_rpc_request",e.SDK_RPC_REQUEST_RECEIVED="sdk_rpc_request_received",e.SDK_RPC_REQUEST_DONE="sdk_rpc_request_done",e.SDK_EXTENSION_UTILIZED="sdk_extension_utilized",e.SDK_USE_INAPP_BROWSER="sdk_use_inapp_browser"}(ht||(ht={}));const ft="SDK_CONNECTION_ISSUE";var mt;!function(e){e.RPC_CHECK="rpcCheck",e.SKIPPED_RPC="skippedRpc"}(mt||(mt={}));const gt=["eth_sendTransaction","eth_signTypedData","eth_signTransaction","personal_sign","wallet_requestPermissions","wallet_switchEthereumChain","eth_signTypedData_v3","eth_signTypedData_v4","metamask_connectSign","metamask_connectWith","metamask_batch"].map((e=>e.toLowerCase()));function pt(e,t){var n,o,i,r;if(!e.state.channelId)throw new Error("Create a channel first");z.SocketService(`[SocketService: handleSendMessage()] context=${e.state.context} areKeysExchanged=${null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()}`,t);(null===(o=null==t?void 0:t.type)||void 0===o?void 0:o.startsWith("key_handshake"))?function(e,t){var n;z.SocketService(`[SocketService: handleKeyHandshake()] context=${e.state.context}`,t),null===(n=e.state.socket)||void 0===n||n.emit(nt.MESSAGE,{id:e.state.channelId,context:e.state.context,message:t})}(e,t):(!function(e,t){var n;if(!(null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()))throw z.SocketService(`[SocketService: validateKeyExchange()] context=${e.state.context} ERROR keys not exchanged`,t),new Error("Keys not exchanged BBB")}(e,t),function(e,t){var n;const o=null!==(n=null==t?void 0:t.method)&&void 0!==n?n:"",i=null==t?void 0:t.id;e.state.isOriginator&&i&&(e.state.rpcMethodTracker[i]={id:i,timestamp:Date.now(),method:o},e.emit(nt.RPC_UPDATE,e.state.rpcMethodTracker[i]))}(e,t),function(e,t){var n,o;const i=null===(n=e.state.keyExchange)||void 0===n?void 0:n.encryptMessage(JSON.stringify(t)),r={id:e.state.channelId,context:e.state.context,message:i,plaintext:e.state.hasPlaintext?JSON.stringify(t):void 0};z.SocketService(`[SocketService: encryptAndSendMessage()] context=${e.state.context}`,r),t.type===rt.TERMINATE&&(e.state.manualDisconnect=!0),null===(o=e.state.socket)||void 0===o||o.emit(nt.MESSAGE,r)}(e,t),e.remote.state.analytics&&e.remote.state.isOriginator&&t.method&&gt.includes(t.method.toLowerCase())&&Z({id:null!==(i=e.remote.state.channelId)&&void 0!==i?i:"",event:ht.SDK_RPC_REQUEST,sdkVersion:e.remote.state.sdkVersion,commLayerVersion:Je.version,walletVersion:null===(r=e.remote.state.walletInfo)||void 0===r?void 0:r.version,params:{method:t.method,from:"mobile"}},e.remote.state.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)})),function(e,t){var n;return c(this,void 0,void 0,(function*(){const o=null==t?void 0:t.id,i=null!==(n=null==t?void 0:t.method)&&void 0!==n?n:"";if(e.state.isOriginator&&o)try{const n=ct(o,e.state.rpcMethodTracker,200).then((e=>({type:mt.RPC_CHECK,result:e}))),r=(()=>c(this,void 0,void 0,(function*(){const t=yield ut({instance:e,rpcId:o}),n=yield ct(t,e.state.rpcMethodTracker,200);return{type:mt.SKIPPED_RPC,result:n}})))(),s=yield Promise.race([n,r]);if(s.type===mt.RPC_CHECK){const e=s.result;z.SocketService(`[SocketService:handleRpcReplies()] id=${t.id} ${i} ( ${e.elapsedTime} ms)`,e.result)}else{if(s.type!==mt.SKIPPED_RPC)throw new Error(`Error handling RPC replies for ${o}`);{const{result:t}=s;console.warn(`[SocketService handleRpcReplies()] RPC METHOD HAS BEEN SKIPPED rpcid=${o} method=${i}`,t);const n=Object.assign(Object.assign({},e.state.rpcMethodTracker[o]),{error:new Error(ft)});e.emit(nt.RPC_UPDATE,n);const r={data:Object.assign(Object.assign({},n),{jsonrpc:"2.0"}),name:"metamask-provider"};e.emit(nt.MESSAGE,{message:r})}}}catch(e){throw console.warn(`[SocketService handleRpcReplies()] Error rpcId=${t.id} ${i}`,e),e}}))}(e,t).catch((e=>{console.warn("Error handleRpcReplies",e)})))}const yt=[{event:"clients_connected",handler:function(e,t){return n=>c(this,void 0,void 0,(function*(){var n,o,i,r,s,a,c,u;z.SocketService(`[SocketService: handleClientsConnected()] context=${e.state.context} on 'clients_connected-${t}'  resumed=${e.state.resumed}  clientsPaused=${e.state.clientsPaused} keysExchanged=${null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()} isOriginator=${e.state.isOriginator}`),e.emit(nt.CLIENTS_CONNECTED,{isOriginator:e.state.isOriginator,keysExchanged:null===(o=e.state.keyExchange)||void 0===o?void 0:o.areKeysExchanged(),context:e.state.context}),e.state.resumed?(e.state.isOriginator||(z.SocketService(`[SocketService: handleClientsConnected()] context=${e.state.context} 'clients_connected' / keysExchanged=${null===(i=e.state.keyExchange)||void 0===i?void 0:i.areKeysExchanged()} -- backward compatibility`),null===(r=e.state.keyExchange)||void 0===r||r.start({isOriginator:null!==(s=e.state.isOriginator)&&void 0!==s&&s})),e.state.resumed=!1):e.state.clientsPaused?z.SocketService("[SocketService: handleClientsConnected()] 'clients_connected' skip sending originatorInfo on pause"):e.state.isOriginator||(z.SocketService(`[SocketService: handleClientsConnected()] context=${e.state.context} on 'clients_connected' / keysExchanged=${null===(a=e.state.keyExchange)||void 0===a?void 0:a.areKeysExchanged()} -- backward compatibility`),null===(c=e.state.keyExchange)||void 0===c||c.start({isOriginator:null!==(u=e.state.isOriginator)&&void 0!==u&&u,force:!0})),e.state.clientsConnected=!0,e.state.clientsPaused=!1}))}},{event:"channel_created",handler:function(e,t){return n=>{z.SocketService(`[SocketService: handleChannelCreated()] context=${e.state.context} on 'channel_created-${t}'`,n),e.emit(nt.CHANNEL_CREATED,n)}}},{event:"clients_disconnected",handler:function(e,t){return()=>{var n;e.state.clientsConnected=!1,z.SocketService(`[SocketService: handlesClientsDisconnected()] context=${e.state.context} on 'clients_disconnected-${t}'`),e.state.isOriginator&&!e.state.clientsPaused&&(null===(n=e.state.keyExchange)||void 0===n||n.clean()),e.emit(nt.CLIENTS_DISCONNECTED,t)}}},{event:"message",handler:function(e,t){return({id:n,message:o,error:i})=>{var r,s,a,c,u,l,d,h,f,m,g,p,y,v,E,C,S;if(z.SocketService(`[SocketService handleMessage()] context=${e.state.context} on 'message' ${t} keysExchanged=${null===(r=e.state.keyExchange)||void 0===r?void 0:r.areKeysExchanged()}`,o),i)throw z.SocketService(`\n      [SocketService handleMessage()] context=${e.state.context}::on 'message' error=${i}`),new Error(i);try{!function(e,t){if(t!==e.channelId)throw e.debug&&console.error(`Wrong id ${t} - should be ${e.channelId}`),new Error("Wrong id")}(e.state,n)}catch(e){return void console.error("ignore message --- wrong id ",o)}if(e.state.isOriginator&&(null==o?void 0:o.type)===it.KEY_HANDSHAKE_START)return z.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' received HANDSHAKE_START isOriginator=${e.state.isOriginator}`,o),void(null===(s=e.state.keyExchange)||void 0===s||s.start({isOriginator:null!==(a=e.state.isOriginator)&&void 0!==a&&a,force:!0}));if((null==o?void 0:o.type)===rt.PING)return z.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' ping `),void e.emit(nt.MESSAGE,{message:{type:"ping"}});if(z.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' originator=${e.state.isOriginator}, type=${null==o?void 0:o.type}, keysExchanged=${null===(c=e.state.keyExchange)||void 0===c?void 0:c.areKeysExchanged()}`),null===(u=null==o?void 0:o.type)||void 0===u?void 0:u.startsWith("key_handshake"))return z.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' emit KEY_EXCHANGE`,o),void e.emit(ot.KEY_EXCHANGE,{message:o,context:e.state.context});if(null===(l=e.state.keyExchange)||void 0===l?void 0:l.areKeysExchanged()){if(-1!==o.toString().indexOf("type"))return console.warn("[SocketService handleMessage() ::on 'message' received non encrypted unkwown message"),void e.emit(nt.MESSAGE,o)}else{let t=!1;try{null===(d=e.state.keyExchange)||void 0===d||d.decryptMessage(o),t=!0}catch(e){}if(!t)return e.state.isOriginator?null===(f=e.state.keyExchange)||void 0===f||f.start({isOriginator:null!==(m=e.state.isOriginator)&&void 0!==m&&m}):e.sendMessage({type:it.KEY_HANDSHAKE_START}),void console.warn(`Message ignored because invalid key exchange status. step=${null===(g=e.state.keyExchange)||void 0===g?void 0:g.getKeyInfo().step}`,null===(p=e.state.keyExchange)||void 0===p?void 0:p.getKeyInfo(),o);console.warn("Invalid key exchange status detected --- updating it."),null===(h=e.state.keyExchange)||void 0===h||h.setKeysExchanged(!0)}const k=null===(y=e.state.keyExchange)||void 0===y?void 0:y.decryptMessage(o),_=JSON.parse(null!=k?k:"{}");if((null==_?void 0:_.type)===rt.PAUSE?e.state.clientsPaused=!0:e.state.clientsPaused=!1,e.state.isOriginator&&_.data){const t=_.data,n=e.state.rpcMethodTracker[t.id];if(n){const o=Date.now()-n.timestamp;z.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' received answer for id=${t.id} method=${n.method} responseTime=${o}`,_),e.remote.state.analytics&&gt.includes(n.method.toLowerCase())&&Z({id:null!==(v=e.remote.state.channelId)&&void 0!==v?v:"",event:ht.SDK_RPC_REQUEST_DONE,sdkVersion:e.remote.state.sdkVersion,commLayerVersion:Je.version,walletVersion:null===(E=e.remote.state.walletInfo)||void 0===E?void 0:E.version,params:{method:n.method,from:"mobile"}},e.remote.state.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}));const i=Object.assign(Object.assign({},n),{result:t.result,error:t.error?{code:null===(C=t.error)||void 0===C?void 0:C.code,message:null===(S=t.error)||void 0===S?void 0:S.message}:void 0,elapsedTime:o});e.state.rpcMethodTracker[t.id]=i,e.emit(nt.RPC_UPDATE,i)}}e.emit(nt.MESSAGE,{message:_})}}},{event:"clients_waiting_to_join",handler:function(e,t){return n=>{z.SocketService(`[SocketService: handleClientsWaitingToJoin()] context=${e.state.context} on 'clients_waiting_to_join-${t}'`,n),e.emit(nt.CLIENTS_WAITING,n)}}}],vt=[{event:nt.KEY_INFO,handler:function(e){return t=>{z.SocketService("[SocketService: handleKeyInfo()] on 'KEY_INFO'",t),e.emit(nt.KEY_INFO,t)}}},{event:nt.KEYS_EXCHANGED,handler:function(e){return()=>{var t,n;z.SocketService(`[SocketService: handleKeysExchanged()] on 'keys_exchanged' keyschanged=${null===(t=e.state.keyExchange)||void 0===t?void 0:t.areKeysExchanged()}`),e.emit(nt.KEYS_EXCHANGED,{keysExchanged:null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged(),isOriginator:e.state.isOriginator});const o={keyInfo:e.getKeyInfo()};e.emit(nt.SERVICE_STATUS,o)}}}];function Et(e,t){z.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} setting socket listeners for channel ${t}...`);const{socket:n}=e.state,{keyExchange:o}=e.state;e.state.setupChannelListeners&&console.warn(`[SocketService: setupChannelListener()] context=${e.state.context} socket listeners already set up for channel ${t}`),n&&e.state.isOriginator&&(e.state.debug&&(null==n||n.io.on("error",(t=>{z.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=error`,t)})),null==n||n.io.on("reconnect",(t=>{z.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=reconnect`,t)})),null==n||n.io.on("reconnect_error",(t=>{z.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=reconnect_error`,t)})),null==n||n.io.on("reconnect_failed",(()=>{z.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=reconnect_failed`)})),null==n||n.io.on("ping",(()=>{z.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=ping`)}))),null==n||n.on("disconnect",(t=>(z.SocketService(`[SocketService: setupChannelListener()] on 'disconnect' -- MetaMaskSDK socket disconnected '${t}' begin recovery...`),dt(e)(t))))),yt.forEach((({event:o,handler:i})=>{const r=`${o}-${t}`;null==n||n.on(r,i(e,t))})),vt.forEach((({event:t,handler:n})=>{null==o||o.on(t,n(e))})),e.state.setupChannelListeners=!0}class Ct extends i{constructor({otherPublicKey:e,reconnect:t,communicationLayerPreference:n,transports:o,communicationServerUrl:i,context:r,ecies:s,remote:c,logging:u}){super(),this.state={clientsConnected:!1,clientsPaused:!1,manualDisconnect:!1,lastRpcId:void 0,rpcMethodTracker:{},hasPlaintext:!1,communicationServerUrl:""},this.state.resumed=t,this.state.context=r,this.state.communicationLayerPreference=n,this.state.debug=!0===(null==u?void 0:u.serviceLayer),this.remote=c,!0===(null==u?void 0:u.serviceLayer)&&H.enable("SocketService:Layer"),this.state.communicationServerUrl=i,this.state.hasPlaintext=this.state.communicationServerUrl!==Ze&&!0===(null==u?void 0:u.plaintext);const l={autoConnect:!1,transports:Xe,withCredentials:!0};o&&(l.transports=o),z.SocketService(`[SocketService: constructor()] Socket IO url: ${this.state.communicationServerUrl}`),this.state.socket=a(i,l);const d={communicationLayer:this,otherPublicKey:e,sendPublicKey:!1,context:this.state.context,ecies:s,logging:u};this.state.keyExchange=new st(d)}resetKeys(){return e=this,z.SocketService("[SocketService: resetKeys()] Resetting keys."),void(null===(t=e.state.keyExchange)||void 0===t||t.resetKeys());var e,t}createChannel(){return function(e){var t,n,o,i;z.SocketService(`[SocketService: createChannel()] context=${e.state.context}`),(null===(t=e.state.socket)||void 0===t?void 0:t.connected)||null===(n=e.state.socket)||void 0===n||n.connect(),e.state.manualDisconnect=!1,e.state.isOriginator=!0;const r=s();return e.state.channelId=r,Et(e,r),null===(o=e.state.socket)||void 0===o||o.emit(nt.JOIN_CHANNEL,r,`${e.state.context}createChannel`),{channelId:r,pubKey:(null===(i=e.state.keyExchange)||void 0===i?void 0:i.getMyPublicKey())||""}}(this)}connectToChannel({channelId:e,isOriginator:t=!1,withKeyExchange:n=!1}){return function({options:e,instance:t}){var n,o,i,r;const{channelId:s,withKeyExchange:a,isOriginator:c}=e;if(z.SocketService(`[SocketService: connectToChannel()] context=${t.state.context} channelId=${s} isOriginator=${c}`,null===(n=t.state.keyExchange)||void 0===n?void 0:n.toString()),null===(o=t.state.socket)||void 0===o?void 0:o.connected)throw new Error("socket already connected");t.state.manualDisconnect=!1,null===(i=t.state.socket)||void 0===i||i.connect(),t.state.withKeyExchange=a,t.state.isOriginator=c,t.state.channelId=s,Et(t,s),null===(r=t.state.socket)||void 0===r||r.emit(nt.JOIN_CHANNEL,s,`${t.state.context}_connectToChannel`)}({options:{channelId:e,isOriginator:t,withKeyExchange:n},instance:this})}getKeyInfo(){return this.state.keyExchange.getKeyInfo()}keyCheck(){var e,t;null===(t=(e=this).state.socket)||void 0===t||t.emit(nt.MESSAGE,{id:e.state.channelId,context:e.state.context,message:{type:it.KEY_HANDSHAKE_CHECK,pubkey:e.getKeyInfo().ecies.otherPubKey}})}getKeyExchange(){return this.state.keyExchange}sendMessage(e){return pt(this,e)}ping(){return e=this,z.SocketService(`[SocketService: ping()] context=${e.state.context} originator=${e.state.isOriginator} keysExchanged=${null===(t=e.state.keyExchange)||void 0===t?void 0:t.areKeysExchanged()}`),e.state.isOriginator&&((null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged())?(console.warn(`[SocketService:ping()] context=${e.state.context} sending READY message`),e.sendMessage({type:rt.READY})):(console.warn(`[SocketService: ping()] context=${e.state.context} starting key exchange`),null===(o=e.state.keyExchange)||void 0===o||o.start({isOriginator:null!==(i=e.state.isOriginator)&&void 0!==i&&i}))),void(null===(r=e.state.socket)||void 0===r||r.emit(nt.MESSAGE,{id:e.state.channelId,context:e.state.context,message:{type:rt.PING}}));var e,t,n,o,i,r}pause(){return e=this,z.SocketService(`[SocketService: pause()] context=${e.state.context}`),e.state.manualDisconnect=!0,(null===(t=e.state.keyExchange)||void 0===t?void 0:t.areKeysExchanged())&&e.sendMessage({type:rt.PAUSE}),void(null===(n=e.state.socket)||void 0===n||n.disconnect());var e,t,n}isConnected(){var e;return null===(e=this.state.socket)||void 0===e?void 0:e.connected}resume(){return e=this,z.SocketService(`[SocketService: resume()] context=${e.state.context} connected=${null===(t=e.state.socket)||void 0===t?void 0:t.connected} manualDisconnect=${e.state.manualDisconnect} resumed=${e.state.resumed} keysExchanged=${null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()}`),(null===(o=e.state.socket)||void 0===o?void 0:o.connected)?z.SocketService("[SocketService: resume()] already connected."):(null===(i=e.state.socket)||void 0===i||i.connect(),z.SocketService(`[SocketService: resume()] after connecting socket --\x3e connected=${null===(r=e.state.socket)||void 0===r?void 0:r.connected}`),null===(s=e.state.socket)||void 0===s||s.emit(nt.JOIN_CHANNEL,e.state.channelId,`${e.state.context}_resume`)),(null===(a=e.state.keyExchange)||void 0===a?void 0:a.areKeysExchanged())?e.state.isOriginator||e.sendMessage({type:rt.READY}):e.state.isOriginator||null===(c=e.state.keyExchange)||void 0===c||c.start({isOriginator:null!==(u=e.state.isOriginator)&&void 0!==u&&u}),e.state.manualDisconnect=!1,void(e.state.resumed=!0);var e,t,n,o,i,r,s,a,c,u}getRPCMethodTracker(){return this.state.rpcMethodTracker}disconnect(e){return function(e,t){var n,o;z.SocketService(`[SocketService: disconnect()] context=${e.state.context}`,t),(null==t?void 0:t.terminate)&&(e.state.channelId=t.channelId,null===(n=e.state.keyExchange)||void 0===n||n.clean()),e.state.rpcMethodTracker={},e.state.manualDisconnect=!0,null===(o=e.state.socket)||void 0===o||o.disconnect()}(this,e)}}var St,kt,_t;function wt(e){return()=>c(this,void 0,void 0,(function*(){var t,n,o;const{state:i}=e;if(i.authorized)return;yield(()=>c(this,void 0,void 0,(function*(){for(;!i.walletInfo;)yield at(500)})))();const r="7.3".localeCompare((null===(t=i.walletInfo)||void 0===t?void 0:t.version)||"");if(z.RemoteCommunication(`[RemoteCommunication: handleAuthorizedEvent()] HACK 'authorized' version=${null===(n=i.walletInfo)||void 0===n?void 0:n.version} compareValue=${r}`),1!==r)return;const s=i.platformType===kt.MobileWeb||i.platformType===kt.ReactNative||i.platformType===kt.MetaMaskMobileWebview;z.RemoteCommunication(`[RemoteCommunication: handleAuthorizedEvent()] HACK 'authorized' platform=${i.platformType} secure=${s} channel=${i.channelId} walletVersion=${null===(o=i.walletInfo)||void 0===o?void 0:o.version}`),s&&(i.authorized=!0,e.emit(nt.AUTHORIZED))}))}function xt(e){return t=>{const{state:n}=e;z.RemoteCommunication(`[RemoteCommunication: handleChannelCreatedEvent()] context=${n.context} on 'channel_created' channelId=${t}`),e.emit(nt.CHANNEL_CREATED,t)}}function At(e,t){return()=>{var n,o,i,r;const{state:s}=e;if(z.RemoteCommunication(`[RemoteCommunication: handleClientsConnectedEvent()] on 'clients_connected' channel=${s.channelId} keysExchanged=${null===(o=null===(n=s.communicationLayer)||void 0===n?void 0:n.getKeyInfo())||void 0===o?void 0:o.keysExchanged}`),s.analytics){const e=s.isOriginator?ht.REQUEST:ht.REQUEST_MOBILE;Z(Object.assign(Object.assign({id:null!==(i=s.channelId)&&void 0!==i?i:"",event:s.reconnection?ht.RECONNECT:e},s.originatorInfo),{commLayer:t,sdkVersion:s.sdkVersion,walletVersion:null===(r=s.walletInfo)||void 0===r?void 0:r.version,commLayerVersion:Je.version}),s.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}))}s.clientsConnected=!0,s.originatorInfoSent=!1,e.emit(nt.CLIENTS_CONNECTED)}}function It(e,t){return n=>{var o;const{state:i}=e;z.RemoteCommunication(`[RemoteCommunication: handleClientsDisconnectedEvent()] context=${i.context} on 'clients_disconnected' channelId=${n}`),i.clientsConnected=!1,e.emit(nt.CLIENTS_DISCONNECTED,i.channelId),e.setConnectionStatus(tt.DISCONNECTED),i.ready=!1,i.authorized=!1,i.analytics&&i.channelId&&Z({id:i.channelId,event:ht.DISCONNECTED,sdkVersion:i.sdkVersion,commLayer:t,commLayerVersion:Je.version,walletVersion:null===(o=i.walletInfo)||void 0===o?void 0:o.version},i.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}))}}function Rt(e){return t=>{var n;const{state:o}=e;if(z.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] context=${o.context} on 'clients_waiting' numberUsers=${t} ready=${o.ready} autoStarted=${o.originatorConnectStarted}`),e.setConnectionStatus(tt.WAITING),e.emit(nt.CLIENTS_WAITING,t),o.originatorConnectStarted){z.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] on 'clients_waiting' watch autoStarted=${o.originatorConnectStarted} timeout`,o.autoConnectOptions);const t=(null===(n=o.autoConnectOptions)||void 0===n?void 0:n.timeout)||3e3,i=setTimeout((()=>{z.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] setTimeout(${t}) terminate channelConfig`,o.autoConnectOptions),o.originatorConnectStarted=!1,o.ready||e.setConnectionStatus(tt.TIMEOUT),clearTimeout(i)}),t)}}}function bt(e,t){return n=>{var o,i,r,s,a;const{state:c}=e;z.RemoteCommunication(`[RemoteCommunication: handleKeysExchangedEvent()] context=${c.context} on commLayer.'keys_exchanged' channel=${c.channelId}`,n),(null===(i=null===(o=c.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.keysExchanged)&&e.setConnectionStatus(tt.LINKED),function(e,t){var n,o,i,r;const{state:s}=e;z.RemoteCommunication(`[RemoteCommunication: setLastActiveDate()] channel=${s.channelId}`,t);const a={channelId:null!==(n=s.channelId)&&void 0!==n?n:"",validUntil:null!==(i=null===(o=s.channelConfig)||void 0===o?void 0:o.validUntil)&&void 0!==i?i:0,lastActive:t.getTime()};null===(r=s.storageManager)||void 0===r||r.persistChannelConfig(a)}(e,new Date),c.analytics&&c.channelId&&Z({id:c.channelId,event:n.isOriginator?ht.CONNECTED:ht.CONNECTED_MOBILE,sdkVersion:c.sdkVersion,commLayer:t,commLayerVersion:Je.version,walletVersion:null===(r=c.walletInfo)||void 0===r?void 0:r.version},c.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)})),c.isOriginator=n.isOriginator,n.isOriginator||(null===(s=c.communicationLayer)||void 0===s||s.sendMessage({type:rt.READY}),c.ready=!0,c.paused=!1),n.isOriginator&&!c.originatorInfoSent&&(null===(a=c.communicationLayer)||void 0===a||a.sendMessage({type:rt.ORIGINATOR_INFO,originatorInfo:c.originatorInfo,originator:c.originatorInfo}),c.originatorInfoSent=!0)}}function Kt(e,t){const{state:n}=t;if(z.RemoteCommunication(`[RemoteCommunication: onCommunicationLayerMessage()] context=${n.context} on 'message' typeof=${typeof e}`,e),t.state.ready=!0,n.isOriginator||e.type!==rt.ORIGINATOR_INFO)if(n.isOriginator&&e.type===rt.WALLET_INFO)!function(e,t){const{state:n}=e;n.walletInfo=t.walletInfo,n.paused=!1}(t,e);else{if(e.type===rt.TERMINATE)!function(e){const{state:t}=e;t.isOriginator&&(Pt({options:{terminate:!0,sendMessage:!1},instance:e}),console.debug(),e.emit(nt.TERMINATE))}(t);else if(e.type===rt.PAUSE)!function(e){const{state:t}=e;t.paused=!0,e.setConnectionStatus(tt.PAUSED)}(t);else if(e.type===rt.READY&&n.isOriginator)!function(e){const{state:t}=e;e.setConnectionStatus(tt.LINKED);const n=t.paused;t.paused=!1,e.emit(nt.CLIENTS_READY,{isOriginator:t.isOriginator,walletInfo:t.walletInfo}),n&&(t.authorized=!0,e.emit(nt.AUTHORIZED))}(t);else{if(e.type===rt.OTP&&n.isOriginator)return void function(e,t){var n;const{state:o}=e;e.emit(nt.OTP,t.otpAnswer),1==="6.6".localeCompare((null===(n=o.walletInfo)||void 0===n?void 0:n.version)||"")&&(console.warn("RemoteCommunication::on 'otp' -- backward compatibility <6.6 -- triger eth_requestAccounts"),e.emit(nt.SDK_RPC_CALL,{method:qe.ETH_REQUESTACCOUNTS,params:[]}))}(t,e);e.type===rt.AUTHORIZED&&n.isOriginator&&function(e){const{state:t}=e;t.authorized=!0,e.emit(nt.AUTHORIZED)}(t)}t.emit(nt.MESSAGE,e)}else!function(e,t){var n;const{state:o}=e;null===(n=o.communicationLayer)||void 0===n||n.sendMessage({type:rt.WALLET_INFO,walletInfo:o.walletInfo}),o.originatorInfo=t.originatorInfo||t.originator,e.emit(nt.CLIENTS_READY,{isOriginator:o.isOriginator,originatorInfo:o.originatorInfo}),o.paused=!1}(t,e)}function Tt(e,t){var n,o;return c(this,void 0,void 0,(function*(){const{state:i}=e;z.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${i.context} paused=${i.paused} ready=${i.ready} authorized=${i.authorized} socket=${null===(n=i.communicationLayer)||void 0===n?void 0:n.isConnected()} clientsConnected=${i.clientsConnected} status=${i._connectionStatus}`,t),!i.paused&&i.ready&&(null===(o=i.communicationLayer)||void 0===o?void 0:o.isConnected())&&i.clientsConnected||(z.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${i.context}  SKIP message waiting for MM mobile readiness.`),yield new Promise((t=>{e.once(nt.CLIENTS_READY,t)})),z.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${i.context}  AFTER SKIP / READY -- sending pending message`));try{yield function(e,t){return c(this,void 0,void 0,(function*(){return new Promise((n=>{var o,i,r,s;const{state:a}=e;if(z.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] context=${a.context} ready=${a.ready} authorized=${a.authorized} method=${t.method}`),1==="7.3".localeCompare((null===(o=a.walletInfo)||void 0===o?void 0:o.version)||""))return z.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] compatibility hack wallet version > ${null===(i=a.walletInfo)||void 0===i?void 0:i.version}`),null===(r=a.communicationLayer)||void 0===r||r.sendMessage(t),void n();!a.isOriginator||a.authorized?(null===(s=a.communicationLayer)||void 0===s||s.sendMessage(t),n()):e.once(nt.AUTHORIZED,(()=>{var e;z.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] context=${a.context}  AFTER SKIP / AUTHORIZED -- sending pending message`),null===(e=a.communicationLayer)||void 0===e||e.sendMessage(t),n()}))}))}))}(e,t)}catch(e){throw console.error(`[RemoteCommunication: sendMessage()] context=${i.context}  ERROR`,e),e}}))}function Nt(e){return t=>{let n=t;t.message&&(n=n.message),Kt(n,e)}}function Ot(e){return()=>{const{state:t}=e;z.RemoteCommunication("[RemoteCommunication: handleSocketReconnectEvent()] on 'socket_reconnect' -- reset key exchange status / set ready to false"),t.ready=!1,t.authorized=!1,et(t),e.emitServiceStatusEvent()}}function Dt(e){return()=>{const{state:t}=e;z.RemoteCommunication("[RemoteCommunication: handleSocketDisconnectedEvent()] on 'socket_Disconnected' set ready to false"),t.ready=!1}}function Pt({options:e,instance:t}){var n,o,i,r,a,c;const{state:u}=t;z.RemoteCommunication(`[RemoteCommunication: disconnect()] channel=${u.channelId}`,e),u.ready=!1,u.paused=!1,(null==e?void 0:e.terminate)?(null===(n=u.storageManager)||void 0===n||n.terminate(null!==(o=u.channelId)&&void 0!==o?o:""),(null===(i=u.communicationLayer)||void 0===i?void 0:i.getKeyInfo().keysExchanged)&&(null==e?void 0:e.sendMessage)&&(null===(r=u.communicationLayer)||void 0===r||r.sendMessage({type:rt.TERMINATE})),u.channelId=s(),e.channelId=u.channelId,u.channelConfig=void 0,u.originatorConnectStarted=!1,null===(a=u.communicationLayer)||void 0===a||a.disconnect(e),t.setConnectionStatus(tt.TERMINATED)):(null===(c=u.communicationLayer)||void 0===c||c.disconnect(e),t.setConnectionStatus(tt.DISCONNECTED))}!function(e){e.SOCKET="socket"}(St||(St={})),function(e){e.NonBrowser="nodejs",e.MetaMaskMobileWebview="in-app-browser",e.DesktopWeb="web-desktop",e.MobileWeb="web-mobile",e.ReactNative="react-native"}(kt||(kt={}));class Lt extends i{constructor({platformType:e,communicationLayerPreference:t,otherPublicKey:n,reconnect:o,walletInfo:i,dappMetadata:r,transports:s,context:a,ecies:c,analytics:u=!1,storage:l,sdkVersion:d,communicationServerUrl:h=Ze,logging:f,autoConnect:m={timeout:3e3}}){super(),this.state={ready:!1,authorized:!1,isOriginator:!1,paused:!1,platformType:"metamask-mobile",analytics:!1,reconnection:!1,originatorInfoSent:!1,communicationServerUrl:Ze,context:"",clientsConnected:!1,sessionDuration:Qe,originatorConnectStarted:!1,debug:!1,_connectionStatus:tt.DISCONNECTED},this.state.otherPublicKey=n,this.state.dappMetadata=r,this.state.walletInfo=i,this.state.transports=s,this.state.platformType=e,this.state.analytics=u,this.state.isOriginator=!n,this.state.communicationServerUrl=h,this.state.context=a,this.state.sdkVersion=d,this.setMaxListeners(50),this.setConnectionStatus(tt.DISCONNECTED),(null==l?void 0:l.duration)&&(this.state.sessionDuration=Qe),this.state.storageOptions=l,this.state.autoConnectOptions=m,this.state.debug=!0===(null==f?void 0:f.remoteLayer),!0===(null==f?void 0:f.remoteLayer)&&H.enable("RemoteCommunication:Layer"),this.state.logging=f,(null==l?void 0:l.storageManager)&&(this.state.storageManager=l.storageManager),this.initCommunicationLayer({communicationLayerPreference:t,otherPublicKey:n,reconnect:o,ecies:c,communicationServerUrl:h}),this.emitServiceStatusEvent()}initCommunicationLayer({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,ecies:o,communicationServerUrl:i=Ze}){return function({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,ecies:o,communicationServerUrl:i=Ze,instance:r}){var s,a,c,u,l,d,h,f,m;const{state:g}=r;if(e!==St.SOCKET)throw new Error("Invalid communication protocol");g.communicationLayer=new Ct({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,transports:g.transports,communicationServerUrl:i,context:g.context,ecies:o,logging:g.logging,remote:r});let p="undefined"!=typeof document&&document.URL||"",y="undefined"!=typeof document&&document.title||"";(null===(s=g.dappMetadata)||void 0===s?void 0:s.url)&&(p=g.dappMetadata.url),(null===(a=g.dappMetadata)||void 0===a?void 0:a.name)&&(y=g.dappMetadata.name);const v={url:p,title:y,source:null===(c=g.dappMetadata)||void 0===c?void 0:c.source,dappId:"undefined"==typeof window?null!==(h=null!==(l=null===(u=g.dappMetadata)||void 0===u?void 0:u.name)&&void 0!==l?l:null===(d=g.dappMetadata)||void 0===d?void 0:d.url)&&void 0!==h?h:"unkown":window.location.hostname,icon:(null===(f=g.dappMetadata)||void 0===f?void 0:f.iconUrl)||(null===(m=g.dappMetadata)||void 0===m?void 0:m.base64Icon),platform:g.platformType,apiVersion:Je.version};g.originatorInfo=v;const E={[nt.AUTHORIZED]:wt(r),[nt.MESSAGE]:Nt(r),[nt.CLIENTS_CONNECTED]:At(r,e),[nt.KEYS_EXCHANGED]:bt(r,e),[nt.SOCKET_DISCONNECTED]:Dt(r),[nt.SOCKET_RECONNECT]:Ot(r),[nt.CLIENTS_DISCONNECTED]:It(r,e),[nt.KEY_INFO]:()=>{r.emitServiceStatusEvent()},[nt.CHANNEL_CREATED]:xt(r),[nt.CLIENTS_WAITING]:Rt(r),[nt.RPC_UPDATE]:e=>{r.emit(nt.RPC_UPDATE,e)}};for(const[e,t]of Object.entries(E))try{g.communicationLayer.on(e,t)}catch(t){console.error(`Error registering handler for ${e}:`,t)}}({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,ecies:o,communicationServerUrl:i,instance:this})}originatorSessionConnect(){return c(this,void 0,void 0,(function*(){return yield function(e){var t,n,o;return c(this,void 0,void 0,(function*(){const{state:i}=e;if(!i.storageManager)return void z.RemoteCommunication("[RemoteCommunication: originatorSessionConnect()] no storage manager defined - skip");const r=yield i.storageManager.getPersistedChannelConfig(null!==(t=i.channelId)&&void 0!==t?t:"");if(z.RemoteCommunication(`[RemoteCommunication: originatorSessionConnect()] autoStarted=${i.originatorConnectStarted} channelConfig`,r),null===(n=i.communicationLayer)||void 0===n?void 0:n.isConnected())return z.RemoteCommunication("[RemoteCommunication: originatorSessionConnect()] socket already connected - skip"),r;if(r){if(r.validUntil>Date.now())return i.channelConfig=r,i.originatorConnectStarted=!0,i.channelId=null==r?void 0:r.channelId,i.reconnection=!0,null===(o=i.communicationLayer)||void 0===o||o.connectToChannel({channelId:r.channelId,isOriginator:!0}),r;z.RemoteCommunication("[RemoteCommunication: autoConnect()] Session has expired")}i.originatorConnectStarted=!1}))}(this)}))}generateChannelIdConnect(){return c(this,void 0,void 0,(function*(){return function(e){var t,n,o,i,r;if(!e.communicationLayer)throw new Error("communication layer not initialized");if(e.ready)throw new Error("Channel already connected");if(e.channelId&&(null===(t=e.communicationLayer)||void 0===t?void 0:t.isConnected()))return console.warn("Channel already exists -- interrupt generateChannelId",e.channelConfig),e.channelConfig={channelId:e.channelId,validUntil:Date.now()+e.sessionDuration},null===(n=e.storageManager)||void 0===n||n.persistChannelConfig(e.channelConfig),{channelId:e.channelId,pubKey:null===(i=null===(o=e.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.ecies.public};z.RemoteCommunication("[RemoteCommunication: generateChannelId()]"),et(e);const s=e.communicationLayer.createChannel();z.RemoteCommunication("[RemoteCommunication: generateChannelId()] channel created",s);const a={channelId:s.channelId,validUntil:Date.now()+e.sessionDuration};return e.channelId=s.channelId,e.channelConfig=a,null===(r=e.storageManager)||void 0===r||r.persistChannelConfig(a),{channelId:e.channelId,pubKey:s.pubKey}}(this.state)}))}clean(){return et(this.state)}connectToChannel(e,t){return function({channelId:e,withKeyExchange:t,state:n}){var o,i,s;if(!r(e))throw z.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${n.context} invalid channel channelId=${e}`),new Error(`Invalid channel ${e}`);if(z.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${n.context} channelId=${e}`),null===(o=n.communicationLayer)||void 0===o?void 0:o.isConnected())return void z.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${n.context} already connected - interrupt connection.`);n.channelId=e,null===(i=n.communicationLayer)||void 0===i||i.connectToChannel({channelId:e,withKeyExchange:t});const a={channelId:e,validUntil:Date.now()+n.sessionDuration};n.channelConfig=a,null===(s=n.storageManager)||void 0===s||s.persistChannelConfig(a)}({channelId:e,withKeyExchange:t,state:this.state})}sendMessage(e){return Tt(this,e)}testStorage(){return c(this,void 0,void 0,(function*(){return function(e){var t,n;return c(this,void 0,void 0,(function*(){const o=yield null===(t=e.storageManager)||void 0===t?void 0:t.getPersistedChannelConfig(null!==(n=e.channelId)&&void 0!==n?n:"");z.RemoteCommunication("[RemoteCommunication: testStorage()] res",o)}))}(this.state)}))}getChannelConfig(){return this.state.channelConfig}isReady(){return this.state.ready}isConnected(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.isConnected()}isAuthorized(){return this.state.authorized}isPaused(){return this.state.paused}getCommunicationLayer(){return this.state.communicationLayer}ping(){var e;z.RemoteCommunication(`[RemoteCommunication: ping()] channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.ping()}keyCheck(){var e;z.RemoteCommunication(`[RemoteCommunication: keyCheck()] channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.keyCheck()}setConnectionStatus(e){this.state._connectionStatus!==e&&(this.state._connectionStatus=e,this.emit(nt.CONNECTION_STATUS,e),this.emitServiceStatusEvent())}emitServiceStatusEvent(){this.emit(nt.SERVICE_STATUS,this.getServiceStatus())}getConnectionStatus(){return this.state._connectionStatus}getServiceStatus(){return{originatorInfo:this.state.originatorInfo,keyInfo:this.getKeyInfo(),connectionStatus:this.state._connectionStatus,channelConfig:this.state.channelConfig,channelId:this.state.channelId}}getKeyInfo(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getKeyInfo()}resetKeys(){var e;null===(e=this.state.communicationLayer)||void 0===e||e.resetKeys()}setOtherPublicKey(e){var t;const n=null===(t=this.state.communicationLayer)||void 0===t?void 0:t.getKeyExchange();if(!n)throw new Error("KeyExchange is not initialized.");n.getOtherPublicKey()!==e&&n.setOtherPublicKey(e)}pause(){var e;z.RemoteCommunication(`[RemoteCommunication: pause()] channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.pause(),this.setConnectionStatus(tt.PAUSED)}getVersion(){return Je.version}resume(){return function(e){var t;const{state:n}=e;z.RemoteCommunication(`[RemoteCommunication: resume()] channel=${n.channelId}`),null===(t=n.communicationLayer)||void 0===t||t.resume(),e.setConnectionStatus(tt.LINKED)}(this)}getChannelId(){return this.state.channelId}getRPCMethodTracker(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getRPCMethodTracker()}disconnect(e){return Pt({options:e,instance:this})}}!function(e){e.RENEW="renew",e.LINK="link"}(_t||(_t={}));export{_t as AutoConnectType,St as CommunicationLayerPreference,tt as ConnectionStatus,Ze as DEFAULT_SERVER_URL,We as ECIES,nt as EventType,it as KeyExchangeMessageType,rt as MessageType,kt as PlatformType,Lt as RemoteCommunication,Z as SendAnalytics,Ct as SocketService,ht as TrackingEvents};
//# sourceMappingURL=metamask-sdk-communication-layer.js.map
