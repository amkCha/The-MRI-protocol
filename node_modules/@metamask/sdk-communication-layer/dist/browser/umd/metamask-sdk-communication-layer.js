!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("cross-fetch"),require("eciesjs"),require("eventemitter2"),require("socket.io-client")):"function"==typeof define&&define.amd?define(["exports","cross-fetch","eciesjs","eventemitter2","socket.io-client"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).browser={},e.crossFetch,e.eciesjs,e.eventemitter2,e.socket_ioClient)}(this,(function(e,t,n,o,i){"use strict";function r(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;var s="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function a(){throw new Error("setTimeout has not been defined")}function c(){throw new Error("clearTimeout has not been defined")}var u=a,l=c;function d(e){if(u===setTimeout)return setTimeout(e,0);if((u===a||!u)&&setTimeout)return u=setTimeout,setTimeout(e,0);try{return u(e,0)}catch(t){try{return u.call(null,e,0)}catch(t){return u.call(this,e,0)}}}"function"==typeof s.setTimeout&&(u=setTimeout),"function"==typeof s.clearTimeout&&(l=clearTimeout);var h,g=[],f=!1,m=-1;function y(){f&&h&&(f=!1,h.length?g=h.concat(g):m=-1,g.length&&p())}function p(){if(!f){var e=d(y);f=!0;for(var t=g.length;t;){for(h=g,g=[];++m<t;)h&&h[m].run();m=-1,t=g.length}h=null,f=!1,function(e){if(l===clearTimeout)return clearTimeout(e);if((l===c||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(e);try{return l(e)}catch(t){try{return l.call(null,e)}catch(t){return l.call(this,e)}}}(e)}}function v(e,t){this.fun=e,this.array=t}v.prototype.run=function(){this.fun.apply(null,this.array)};function E(){}var C=E,S=E,k=E,T=E,x=E,w=E,_=E;var A=s.performance||{},I=A.now||A.mozNow||A.msNow||A.oNow||A.webkitNow||function(){return(new Date).getTime()};var K=new Date;var R={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];g.push(new v(e,t)),1!==g.length||f||d(p)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:C,addListener:S,once:k,off:T,removeListener:x,removeAllListeners:w,emit:_,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*I.call(A),n=Math.floor(t),o=Math.floor(t%1*1e9);return e&&(n-=e[0],(o-=e[1])<0&&(n--,o+=1e9)),[n,o]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-K)/1e3}};function b(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var N,O,M={exports:{}};function D(){if(O)return N;O=1;var e=1e3,t=60*e,n=60*t,o=24*n,i=7*o,r=365.25*o;function s(e,t,n,o){var i=t>=1.5*n;return Math.round(e/n)+" "+o+(i?"s":"")}return N=function(a,c){c=c||{};var u=typeof a;if("string"===u&&a.length>0)return function(s){if((s=String(s)).length>100)return;var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(s);if(!a)return;var c=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*r;case"weeks":case"week":case"w":return c*i;case"days":case"day":case"d":return c*o;case"hours":case"hour":case"hrs":case"hr":case"h":return c*n;case"minutes":case"minute":case"mins":case"min":case"m":return c*t;case"seconds":case"second":case"secs":case"sec":case"s":return c*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(a);if("number"===u&&isFinite(a))return c.long?function(i){var r=Math.abs(i);if(r>=o)return s(i,r,o,"day");if(r>=n)return s(i,r,n,"hour");if(r>=t)return s(i,r,t,"minute");if(r>=e)return s(i,r,e,"second");return i+" ms"}(a):function(i){var r=Math.abs(i);if(r>=o)return Math.round(i/o)+"d";if(r>=n)return Math.round(i/n)+"h";if(r>=t)return Math.round(i/t)+"m";if(r>=e)return Math.round(i/e)+"s";return i+"ms"}(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))}}var P=function(e){function t(e){let o,i,r,s=null;function a(...e){if(!a.enabled)return;const n=a,i=Number(new Date),r=i-(o||i);n.diff=r,n.prev=o,n.curr=i,o=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((o,i)=>{if("%%"===o)return"%";s++;const r=t.formatters[i];if("function"==typeof r){const t=e[s];o=r.call(n,t),e.splice(s,1),s--}return o})),t.formatArgs.call(n,e);(n.log||t.log).apply(n,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=n,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==s?s:(i!==t.namespaces&&(i=t.namespaces,r=t.enabled(e)),r),set:e=>{s=e}}),"function"==typeof t.init&&t.init(a),a}function n(e,n){const o=t(this.namespace+(void 0===n?":":n)+e);return o.log=this.log,o}function o(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(o),...t.skips.map(o).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let n;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const o=("string"==typeof e?e:"").split(/[\s,]+/),i=o.length;for(n=0;n<i;n++)o[n]&&("-"===(e=o[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let n,o;for(n=0,o=t.skips.length;n<o;n++)if(t.skips[n].test(e))return!1;for(n=0,o=t.names.length;n<o;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=D(),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((n=>{t[n]=e[n]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t};!function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let o=0,i=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(o++,"%c"===e&&(i=o))})),t.splice(i,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==R&&"env"in R&&(e=R.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=P(t);const{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(M,M.exports);var L=b(M.exports);const $=L("KeyExchange:Layer"),U=L("SocketService:Layer"),H=L("Ecies:Layer"),Y=L("RemoteCommunication:Layer");$.color="##95c44e",U.color="#f638d7",H.color="#465b9c",Y.color="#47a2be";const F={KeyExchange:$,SocketService:U,Ecies:H,RemoteCommunication:Y};let j,B=[],z=[];function V(e){return r(this,void 0,void 0,(function*(){if(!j||!e)return;!function(){const e=z;z=B,B=e}();const n=j.endsWith("/")?`${j}debug`:`${j}/debug`,o=Object.assign({},e);if(delete o.params,e.params)for(const[t,n]of Object.entries(e.params))o[t]=n;const i=JSON.stringify(o);F.RemoteCommunication(`[sendBufferedEvents] Sending ${B.length} analytics events to ${n}`);try{const e=yield t(n,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:i}),o=yield e.text();F.RemoteCommunication(`[sendBufferedEvents] Response: ${o}`),B.length=0}catch(e){console.warn("Error sending analytics",e)}}))}const G=(e,t)=>r(void 0,void 0,void 0,(function*(){var n;j=t,n=e,z.push(n),V(e).catch((()=>{}))}));var W=[],J=[],q="undefined"!=typeof Uint8Array?Uint8Array:Array,Z=!1;function X(){Z=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)W[t]=e[t],J[e.charCodeAt(t)]=t;J["-".charCodeAt(0)]=62,J["_".charCodeAt(0)]=63}function Q(e,t,n){for(var o,i,r=[],s=t;s<n;s+=3)o=(e[s]<<16)+(e[s+1]<<8)+e[s+2],r.push(W[(i=o)>>18&63]+W[i>>12&63]+W[i>>6&63]+W[63&i]);return r.join("")}function ee(e){var t;Z||X();for(var n=e.length,o=n%3,i="",r=[],s=16383,a=0,c=n-o;a<c;a+=s)r.push(Q(e,a,a+s>c?c:a+s));return 1===o?(t=e[n-1],i+=W[t>>2],i+=W[t<<4&63],i+="=="):2===o&&(t=(e[n-2]<<8)+e[n-1],i+=W[t>>10],i+=W[t>>4&63],i+=W[t<<2&63],i+="="),r.push(i),r.join("")}function te(e,t,n,o,i){var r,s,a=8*i-o-1,c=(1<<a)-1,u=c>>1,l=-7,d=n?i-1:0,h=n?-1:1,g=e[t+d];for(d+=h,r=g&(1<<-l)-1,g>>=-l,l+=a;l>0;r=256*r+e[t+d],d+=h,l-=8);for(s=r&(1<<-l)-1,r>>=-l,l+=o;l>0;s=256*s+e[t+d],d+=h,l-=8);if(0===r)r=1-u;else{if(r===c)return s?NaN:1/0*(g?-1:1);s+=Math.pow(2,o),r-=u}return(g?-1:1)*s*Math.pow(2,r-o)}function ne(e,t,n,o,i,r){var s,a,c,u=8*r-i-1,l=(1<<u)-1,d=l>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,g=o?0:r-1,f=o?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+d>=1?h/c:h*Math.pow(2,1-d))*c>=2&&(s++,c/=2),s+d>=l?(a=0,s=l):s+d>=1?(a=(t*c-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[n+g]=255&a,g+=f,a/=256,i-=8);for(s=s<<i|a,u+=i;u>0;e[n+g]=255&s,g+=f,s/=256,u-=8);e[n+g-f]|=128*m}var oe={}.toString,ie=Array.isArray||function(e){return"[object Array]"==oe.call(e)};function re(){return ae.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function se(e,t){if(re()<t)throw new RangeError("Invalid typed array length");return ae.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=ae.prototype:(null===e&&(e=new ae(t)),e.length=t),e}function ae(e,t,n){if(!(ae.TYPED_ARRAY_SUPPORT||this instanceof ae))return new ae(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return le(this,e)}return ce(this,e,t,n)}function ce(e,t,n,o){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,o){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(o||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===o?new Uint8Array(t):void 0===o?new Uint8Array(t,n):new Uint8Array(t,n,o);ae.TYPED_ARRAY_SUPPORT?(e=t).__proto__=ae.prototype:e=de(e,t);return e}(e,t,n,o):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!ae.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var o=0|fe(t,n);e=se(e,o);var i=e.write(t,n);i!==o&&(e=e.slice(0,i));return e}(e,t,n):function(e,t){if(ge(t)){var n=0|he(t.length);return 0===(e=se(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(o=t.length)!=o?se(e,0):de(e,t);if("Buffer"===t.type&&ie(t.data))return de(e,t.data)}var o;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function ue(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function le(e,t){if(ue(t),e=se(e,t<0?0:0|he(t)),!ae.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function de(e,t){var n=t.length<0?0:0|he(t.length);e=se(e,n);for(var o=0;o<n;o+=1)e[o]=255&t[o];return e}function he(e){if(e>=re())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+re().toString(16)+" bytes");return 0|e}function ge(e){return!(null==e||!e._isBuffer)}function fe(e,t){if(ge(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var o=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return Ye(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return Fe(e).length;default:if(o)return Ye(e).length;t=(""+t).toLowerCase(),o=!0}}function me(e,t,n){var o=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return Re(this,t,n);case"utf8":case"utf-8":return _e(this,t,n);case"ascii":return Ie(this,t,n);case"latin1":case"binary":return Ke(this,t,n);case"base64":return we(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return be(this,t,n);default:if(o)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),o=!0}}function ye(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function pe(e,t,n,o,i){if(0===e.length)return-1;if("string"==typeof n?(o=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=ae.from(t,o)),ge(t))return 0===t.length?-1:ve(e,t,n,o,i);if("number"==typeof t)return t&=255,ae.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):ve(e,[t],n,o,i);throw new TypeError("val must be string, number or Buffer")}function ve(e,t,n,o,i){var r,s=1,a=e.length,c=t.length;if(void 0!==o&&("ucs2"===(o=String(o).toLowerCase())||"ucs-2"===o||"utf16le"===o||"utf-16le"===o)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var l=-1;for(r=n;r<a;r++)if(u(e,r)===u(t,-1===l?0:r-l)){if(-1===l&&(l=r),r-l+1===c)return l*s}else-1!==l&&(r-=r-l),l=-1}else for(n+c>a&&(n=a-c),r=n;r>=0;r--){for(var d=!0,h=0;h<c;h++)if(u(e,r+h)!==u(t,h)){d=!1;break}if(d)return r}return-1}function Ee(e,t,n,o){n=Number(n)||0;var i=e.length-n;o?(o=Number(o))>i&&(o=i):o=i;var r=t.length;if(r%2!=0)throw new TypeError("Invalid hex string");o>r/2&&(o=r/2);for(var s=0;s<o;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function Ce(e,t,n,o){return je(Ye(t,e.length-n),e,n,o)}function Se(e,t,n,o){return je(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,o)}function ke(e,t,n,o){return Se(e,t,n,o)}function Te(e,t,n,o){return je(Fe(t),e,n,o)}function xe(e,t,n,o){return je(function(e,t){for(var n,o,i,r=[],s=0;s<e.length&&!((t-=2)<0);++s)o=(n=e.charCodeAt(s))>>8,i=n%256,r.push(i),r.push(o);return r}(t,e.length-n),e,n,o)}function we(e,t,n){return 0===t&&n===e.length?ee(e):ee(e.slice(t,n))}function _e(e,t,n){n=Math.min(e.length,n);for(var o=[],i=t;i<n;){var r,s,a,c,u=e[i],l=null,d=u>239?4:u>223?3:u>191?2:1;if(i+d<=n)switch(d){case 1:u<128&&(l=u);break;case 2:128==(192&(r=e[i+1]))&&(c=(31&u)<<6|63&r)>127&&(l=c);break;case 3:r=e[i+1],s=e[i+2],128==(192&r)&&128==(192&s)&&(c=(15&u)<<12|(63&r)<<6|63&s)>2047&&(c<55296||c>57343)&&(l=c);break;case 4:r=e[i+1],s=e[i+2],a=e[i+3],128==(192&r)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&r)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(l=c)}null===l?(l=65533,d=1):l>65535&&(l-=65536,o.push(l>>>10&1023|55296),l=56320|1023&l),o.push(l),i+=d}return function(e){var t=e.length;if(t<=Ae)return String.fromCharCode.apply(String,e);var n="",o=0;for(;o<t;)n+=String.fromCharCode.apply(String,e.slice(o,o+=Ae));return n}(o)}ae.TYPED_ARRAY_SUPPORT=void 0===s.TYPED_ARRAY_SUPPORT||s.TYPED_ARRAY_SUPPORT,re(),ae.poolSize=8192,ae._augment=function(e){return e.__proto__=ae.prototype,e},ae.from=function(e,t,n){return ce(null,e,t,n)},ae.TYPED_ARRAY_SUPPORT&&(ae.prototype.__proto__=Uint8Array.prototype,ae.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&ae[Symbol.species]),ae.alloc=function(e,t,n){return function(e,t,n,o){return ue(t),t<=0?se(e,t):void 0!==n?"string"==typeof o?se(e,t).fill(n,o):se(e,t).fill(n):se(e,t)}(null,e,t,n)},ae.allocUnsafe=function(e){return le(null,e)},ae.allocUnsafeSlow=function(e){return le(null,e)},ae.isBuffer=function(e){return null!=e&&(!!e._isBuffer||Be(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&Be(e.slice(0,0))}(e))},ae.compare=function(e,t){if(!ge(e)||!ge(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,o=t.length,i=0,r=Math.min(n,o);i<r;++i)if(e[i]!==t[i]){n=e[i],o=t[i];break}return n<o?-1:o<n?1:0},ae.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},ae.concat=function(e,t){if(!ie(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return ae.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var o=ae.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var r=e[n];if(!ge(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(o,i),i+=r.length}return o},ae.byteLength=fe,ae.prototype._isBuffer=!0,ae.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)ye(this,t,t+1);return this},ae.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)ye(this,t,t+3),ye(this,t+1,t+2);return this},ae.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)ye(this,t,t+7),ye(this,t+1,t+6),ye(this,t+2,t+5),ye(this,t+3,t+4);return this},ae.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?_e(this,0,e):me.apply(this,arguments)},ae.prototype.equals=function(e){if(!ge(e))throw new TypeError("Argument must be a Buffer");return this===e||0===ae.compare(this,e)},ae.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},ae.prototype.compare=function(e,t,n,o,i){if(!ge(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===o&&(o=0),void 0===i&&(i=this.length),t<0||n>e.length||o<0||i>this.length)throw new RangeError("out of range index");if(o>=i&&t>=n)return 0;if(o>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var r=(i>>>=0)-(o>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(r,s),c=this.slice(o,i),u=e.slice(t,n),l=0;l<a;++l)if(c[l]!==u[l]){r=c[l],s=u[l];break}return r<s?-1:s<r?1:0},ae.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},ae.prototype.indexOf=function(e,t,n){return pe(this,e,t,n,!0)},ae.prototype.lastIndexOf=function(e,t,n){return pe(this,e,t,n,!1)},ae.prototype.write=function(e,t,n,o){if(void 0===t)o="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)o=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===o&&(o="utf8")):(o=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");o||(o="utf8");for(var r=!1;;)switch(o){case"hex":return Ee(this,e,t,n);case"utf8":case"utf-8":return Ce(this,e,t,n);case"ascii":return Se(this,e,t,n);case"latin1":case"binary":return ke(this,e,t,n);case"base64":return Te(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return xe(this,e,t,n);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(""+o).toLowerCase(),r=!0}},ae.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Ae=4096;function Ie(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(127&e[i]);return o}function Ke(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(e[i]);return o}function Re(e,t,n){var o=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>o)&&(n=o);for(var i="",r=t;r<n;++r)i+=He(e[r]);return i}function be(e,t,n){for(var o=e.slice(t,n),i="",r=0;r<o.length;r+=2)i+=String.fromCharCode(o[r]+256*o[r+1]);return i}function Ne(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function Oe(e,t,n,o,i,r){if(!ge(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<r)throw new RangeError('"value" argument is out of bounds');if(n+o>e.length)throw new RangeError("Index out of range")}function Me(e,t,n,o){t<0&&(t=65535+t+1);for(var i=0,r=Math.min(e.length-n,2);i<r;++i)e[n+i]=(t&255<<8*(o?i:1-i))>>>8*(o?i:1-i)}function De(e,t,n,o){t<0&&(t=4294967295+t+1);for(var i=0,r=Math.min(e.length-n,4);i<r;++i)e[n+i]=t>>>8*(o?i:3-i)&255}function Pe(e,t,n,o,i,r){if(n+o>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function Le(e,t,n,o,i){return i||Pe(e,0,n,4),ne(e,t,n,o,23,4),n+4}function $e(e,t,n,o,i){return i||Pe(e,0,n,8),ne(e,t,n,o,52,8),n+8}ae.prototype.slice=function(e,t){var n,o=this.length;if((e=~~e)<0?(e+=o)<0&&(e=0):e>o&&(e=o),(t=void 0===t?o:~~t)<0?(t+=o)<0&&(t=0):t>o&&(t=o),t<e&&(t=e),ae.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=ae.prototype;else{var i=t-e;n=new ae(i,void 0);for(var r=0;r<i;++r)n[r]=this[r+e]}return n},ae.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||Ne(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o},ae.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||Ne(e,t,this.length);for(var o=this[e+--t],i=1;t>0&&(i*=256);)o+=this[e+--t]*i;return o},ae.prototype.readUInt8=function(e,t){return t||Ne(e,1,this.length),this[e]},ae.prototype.readUInt16LE=function(e,t){return t||Ne(e,2,this.length),this[e]|this[e+1]<<8},ae.prototype.readUInt16BE=function(e,t){return t||Ne(e,2,this.length),this[e]<<8|this[e+1]},ae.prototype.readUInt32LE=function(e,t){return t||Ne(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},ae.prototype.readUInt32BE=function(e,t){return t||Ne(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},ae.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||Ne(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},ae.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||Ne(e,t,this.length);for(var o=t,i=1,r=this[e+--o];o>0&&(i*=256);)r+=this[e+--o]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},ae.prototype.readInt8=function(e,t){return t||Ne(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},ae.prototype.readInt16LE=function(e,t){t||Ne(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},ae.prototype.readInt16BE=function(e,t){t||Ne(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},ae.prototype.readInt32LE=function(e,t){return t||Ne(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},ae.prototype.readInt32BE=function(e,t){return t||Ne(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},ae.prototype.readFloatLE=function(e,t){return t||Ne(e,4,this.length),te(this,e,!0,23,4)},ae.prototype.readFloatBE=function(e,t){return t||Ne(e,4,this.length),te(this,e,!1,23,4)},ae.prototype.readDoubleLE=function(e,t){return t||Ne(e,8,this.length),te(this,e,!0,52,8)},ae.prototype.readDoubleBE=function(e,t){return t||Ne(e,8,this.length),te(this,e,!1,52,8)},ae.prototype.writeUIntLE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||Oe(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,r=0;for(this[t]=255&e;++r<n&&(i*=256);)this[t+r]=e/i&255;return t+n},ae.prototype.writeUIntBE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||Oe(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,r=1;for(this[t+i]=255&e;--i>=0&&(r*=256);)this[t+i]=e/r&255;return t+n},ae.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,1,255,0),ae.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},ae.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,2,65535,0),ae.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Me(this,e,t,!0),t+2},ae.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,2,65535,0),ae.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Me(this,e,t,!1),t+2},ae.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,4,4294967295,0),ae.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):De(this,e,t,!0),t+4},ae.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,4,4294967295,0),ae.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):De(this,e,t,!1),t+4},ae.prototype.writeIntLE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);Oe(this,e,t,n,i-1,-i)}var r=0,s=1,a=0;for(this[t]=255&e;++r<n&&(s*=256);)e<0&&0===a&&0!==this[t+r-1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},ae.prototype.writeIntBE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);Oe(this,e,t,n,i-1,-i)}var r=n-1,s=1,a=0;for(this[t+r]=255&e;--r>=0&&(s*=256);)e<0&&0===a&&0!==this[t+r+1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},ae.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,1,127,-128),ae.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},ae.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,2,32767,-32768),ae.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Me(this,e,t,!0),t+2},ae.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,2,32767,-32768),ae.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Me(this,e,t,!1),t+2},ae.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,4,2147483647,-2147483648),ae.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):De(this,e,t,!0),t+4},ae.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),ae.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):De(this,e,t,!1),t+4},ae.prototype.writeFloatLE=function(e,t,n){return Le(this,e,t,!0,n)},ae.prototype.writeFloatBE=function(e,t,n){return Le(this,e,t,!1,n)},ae.prototype.writeDoubleLE=function(e,t,n){return $e(this,e,t,!0,n)},ae.prototype.writeDoubleBE=function(e,t,n){return $e(this,e,t,!1,n)},ae.prototype.copy=function(e,t,n,o){if(n||(n=0),o||0===o||(o=this.length),t>=e.length&&(t=e.length),t||(t=0),o>0&&o<n&&(o=n),o===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(o<0)throw new RangeError("sourceEnd out of bounds");o>this.length&&(o=this.length),e.length-t<o-n&&(o=e.length-t+n);var i,r=o-n;if(this===e&&n<t&&t<o)for(i=r-1;i>=0;--i)e[i+t]=this[i+n];else if(r<1e3||!ae.TYPED_ARRAY_SUPPORT)for(i=0;i<r;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+r),t);return r},ae.prototype.fill=function(e,t,n,o){if("string"==typeof e){if("string"==typeof t?(o=t,t=0,n=this.length):"string"==typeof n&&(o=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==o&&"string"!=typeof o)throw new TypeError("encoding must be a string");if("string"==typeof o&&!ae.isEncoding(o))throw new TypeError("Unknown encoding: "+o)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var r;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(r=t;r<n;++r)this[r]=e;else{var s=ge(e)?e:Ye(new ae(e,o).toString()),a=s.length;for(r=0;r<n-t;++r)this[r+t]=s[r%a]}return this};var Ue=/[^+\/0-9A-Za-z-_]/g;function He(e){return e<16?"0"+e.toString(16):e.toString(16)}function Ye(e,t){var n;t=t||1/0;for(var o=e.length,i=null,r=[],s=0;s<o;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&r.push(239,191,189);continue}if(s+1===o){(t-=3)>-1&&r.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&r.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&r.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;r.push(n)}else if(n<2048){if((t-=2)<0)break;r.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;r.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return r}function Fe(e){return function(e){var t,n,o,i,r,s;Z||X();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");r="="===e[a-2]?2:"="===e[a-1]?1:0,s=new q(3*a/4-r),o=r>0?a-4:a;var c=0;for(t=0,n=0;t<o;t+=4,n+=3)i=J[e.charCodeAt(t)]<<18|J[e.charCodeAt(t+1)]<<12|J[e.charCodeAt(t+2)]<<6|J[e.charCodeAt(t+3)],s[c++]=i>>16&255,s[c++]=i>>8&255,s[c++]=255&i;return 2===r?(i=J[e.charCodeAt(t)]<<2|J[e.charCodeAt(t+1)]>>4,s[c++]=255&i):1===r&&(i=J[e.charCodeAt(t)]<<10|J[e.charCodeAt(t+1)]<<4|J[e.charCodeAt(t+2)]>>2,s[c++]=i>>8&255,s[c++]=255&i),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(Ue,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function je(e,t,n,o){for(var i=0;i<o&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}function Be(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}class ze{constructor(e){this.enabled=!0,(null==e?void 0:e.debug)&&L.enable("Ecies:Layer"),(null==e?void 0:e.pkey)?this.ecies=n.PrivateKey.fromHex(e.pkey):this.ecies=new n.PrivateKey,F.Ecies("[ECIES constructor()] initialized secret: ",this.ecies.toHex()),F.Ecies("[ECIES constructor()] initialized public: ",this.ecies.publicKey.toHex()),F.Ecies("[ECIES constructor()] init with",this)}generateECIES(){this.ecies=new n.PrivateKey}getPublicKey(){return this.ecies.publicKey.toHex()}encrypt(e,t){let o=e;if(this.enabled)try{F.Ecies("[ECIES: encrypt()] using otherPublicKey",t);const i=ae.from(e),r=n.encrypt(t,i);o=ae.from(r).toString("base64")}catch(n){throw F.Ecies("[ECIES: encrypt()] error encrypt:",n),F.Ecies("[ECIES: encrypt()] private: ",this.ecies.toHex()),F.Ecies("[ECIES: encrypt()] data: ",e),F.Ecies("[ECIES: encrypt()] otherkey: ",t),n}return o}decrypt(e){let t=e;if(this.enabled)try{F.Ecies("[ECIES: decrypt()] using privateKey",this.ecies.toHex());const o=ae.from(e.toString(),"base64");t=n.decrypt(this.ecies.toHex(),o).toString()}catch(t){throw F.Ecies("[ECIES: decrypt()] error decrypt",t),F.Ecies("[ECIES: decrypt()] private: ",this.ecies.toHex()),F.Ecies("[ECIES: decrypt()] encryptedData: ",e),t}return t}getKeyInfo(){return{private:this.ecies.toHex(),public:this.ecies.publicKey.toHex()}}toString(){F.Ecies("[ECIES: toString()]",this.getKeyInfo())}}var Ve={name:"@metamask/sdk-communication-layer",version:"0.18.5",description:"",homepage:"https://github.com/MetaMask/metamask-sdk#readme",bugs:{url:"https://github.com/MetaMask/metamask-sdk/issues"},repository:{type:"git",url:"https://github.com/MetaMask/metamask-sdk.git",directory:"packages/sdk-communication-layer"},main:"dist/node/cjs/metamask-sdk-communication-layer.js",unpkg:"dist/browser/umd/metamask-sdk-communication-layer.js",module:"dist/node/es/metamask-sdk-communication-layer.js",browser:"dist/browser/es/metamask-sdk-communication-layer.js","react-native":"dist/react-native/es/metamask-sdk-communication-layer.js",types:"dist/browser/es/src/index.d.ts",files:["/dist"],scripts:{build:"rimraf dist && rollup -c --bundleConfigAsCjs","build:tsc":"tsc","build:dev":"rimraf dist && NODE_ENV=dev rollup -c --bundleConfigAsCjs","build:post-tsc":"echo 'N/A'","build:pre-tsc":"echo 'N/A'",size:"size-limit",clean:"rimraf ./dist",lint:"yarn lint:eslint && yarn lint:misc --check","lint:changelog":"../../scripts/validate-changelog.sh @metamask/sdk-communication-layer","lint:eslint":"eslint . --cache --ext js,ts","lint:fix":"yarn lint:eslint --fix && yarn lint:misc --write","lint:misc":"prettier '**/*.json' '**/*.md' '!CHANGELOG.md' --ignore-path ../../.gitignore","prepare-manifest:preview":"../../scripts/prepare-preview-manifest.sh","publish:preview":"yarn npm publish --tag preview",prepack:"../../scripts/prepack.sh",reset:"yarn clean && rimraf ./node_modules/",test:"jest","test:coverage":"jest --coverage","test:ci":"jest --coverage --passWithNoTests --setupFilesAfterEnv ./jest-preload.js","test:dev":"jest",watch:"rollup -c --bundleConfigAsCjs -w"},dependencies:{bufferutil:"^4.0.8","date-fns":"^2.29.3",debug:"^4.3.4","utf-8-validate":"^6.0.3",uuid:"^8.3.2"},devDependencies:{"@jest/globals":"^29.3.1","@lavamoat/allow-scripts":"^2.3.1","@metamask/auto-changelog":"3.1.0","@metamask/eslint-config":"^6.0.0","@metamask/eslint-config-nodejs":"^6.0.0","@metamask/eslint-config-typescript":"^6.0.0","@rollup/plugin-commonjs":"^25.0.0","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.2","@rollup/plugin-terser":"^0.4.1","@size-limit/preset-big-lib":"^11.0.2","@types/jest":"^29.2.4","@types/node":"^20.1.3","@types/uuid":"^9.0.0","@typescript-eslint/eslint-plugin":"^4.26.0","@typescript-eslint/parser":"^4.26.0","cross-fetch":"^3.1.5",eciesjs:"^0.3.16",eslint:"^7.30.0","eslint-config-prettier":"^8.3.0","eslint-plugin-import":"^2.23.4","eslint-plugin-jest":"^24.4.0","eslint-plugin-jsdoc":"^36.1.0","eslint-plugin-node":"^11.1.0","eslint-plugin-prettier":"^3.4.0",eventemitter2:"^6.4.7",jest:"^29.3.1",prettier:"^2.3.0",rimraf:"^3.0.2",rollup:"^3.21.7","rollup-plugin-jscc":"^2.0.0","rollup-plugin-natives":"^0.7.5","rollup-plugin-node-builtins":"^2.1.2","rollup-plugin-node-globals":"^1.4.0","rollup-plugin-peer-deps-external":"^2.2.4","rollup-plugin-sizes":"^1.0.6","rollup-plugin-typescript2":"^0.31.2","rollup-plugin-visualizer":"^5.9.2","size-limit":"^11.0.2","socket.io-client":"^4.5.1","stream-browserify":"^3.0.0","ts-jest":"^29.0.3","ts-node":"^10.9.1",typescript:"^4.3.2"},peerDependencies:{"cross-fetch":"^3.1.5",eciesjs:"^0.3.16",eventemitter2:"^6.4.7","readable-stream":"^3.6.2","socket.io-client":"^4.5.1"},publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},lavamoat:{allowScripts:{"@lavamoat/preinstall-always-fail":!1,canvas:!0,"eciesjs>secp256k1":!1,"socket.io-client>engine.io-client>ws>bufferutil":!1,"socket.io-client>engine.io-client>ws>utf-8-validate":!1,bufferutil:!1,"utf-8-validate":!1}}};const Ge="https://metamask-sdk.api.cx.metamask.io/",We=["websocket"],Je=6048e5,qe={METAMASK_GETPROVIDERSTATE:"metamask_getProviderState",ETH_REQUESTACCOUNTS:"eth_requestAccounts"};function Ze(e){const{context:t}=e;F.RemoteCommunication(`[RemoteCommunication: clean()] context=${t}`),e.channelConfig=void 0,e.ready=!1,e.originatorConnectStarted=!1}var Xe,Qe=new Uint8Array(16);function et(){if(!Xe&&!(Xe="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Xe(Qe)}var tt=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function nt(e){return"string"==typeof e&&tt.test(e)}for(var ot,it,rt,st,at,ct=[],ut=0;ut<256;++ut)ct.push((ut+256).toString(16).substr(1));function lt(e,t,n){var o=(e=e||{}).random||(e.rng||et)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(var i=0;i<16;++i)t[n+i]=o[i];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(ct[e[t+0]]+ct[e[t+1]]+ct[e[t+2]]+ct[e[t+3]]+"-"+ct[e[t+4]]+ct[e[t+5]]+"-"+ct[e[t+6]]+ct[e[t+7]]+"-"+ct[e[t+8]]+ct[e[t+9]]+"-"+ct[e[t+10]]+ct[e[t+11]]+ct[e[t+12]]+ct[e[t+13]]+ct[e[t+14]]+ct[e[t+15]]).toLowerCase();if(!nt(n))throw TypeError("Stringified UUID is invalid");return n}(o)}e.ConnectionStatus=void 0,(ot=e.ConnectionStatus||(e.ConnectionStatus={})).DISCONNECTED="disconnected",ot.WAITING="waiting",ot.TIMEOUT="timeout",ot.LINKED="linked",ot.PAUSED="paused",ot.TERMINATED="terminated",e.EventType=void 0,(it=e.EventType||(e.EventType={})).KEY_INFO="key_info",it.SERVICE_STATUS="service_status",it.PROVIDER_UPDATE="provider_update",it.RPC_UPDATE="rpc_update",it.KEYS_EXCHANGED="keys_exchanged",it.JOIN_CHANNEL="join_channel",it.CHANNEL_CREATED="channel_created",it.CLIENTS_CONNECTED="clients_connected",it.CLIENTS_DISCONNECTED="clients_disconnected",it.CLIENTS_WAITING="clients_waiting",it.CLIENTS_READY="clients_ready",it.SOCKET_DISCONNECTED="socket_disconnected",it.SOCKET_RECONNECT="socket_reconnect",it.OTP="otp",it.SDK_RPC_CALL="sdk_rpc_call",it.AUTHORIZED="authorized",it.CONNECTION_STATUS="connection_status",it.MESSAGE="message",it.TERMINATE="terminate",function(e){e.KEY_EXCHANGE="key_exchange"}(rt||(rt={})),e.KeyExchangeMessageType=void 0,(st=e.KeyExchangeMessageType||(e.KeyExchangeMessageType={})).KEY_HANDSHAKE_START="key_handshake_start",st.KEY_HANDSHAKE_CHECK="key_handshake_check",st.KEY_HANDSHAKE_SYN="key_handshake_SYN",st.KEY_HANDSHAKE_SYNACK="key_handshake_SYNACK",st.KEY_HANDSHAKE_ACK="key_handshake_ACK",st.KEY_HANDSHAKE_NONE="none";class dt extends o.EventEmitter2{constructor({communicationLayer:t,otherPublicKey:n,context:o,ecies:i,logging:r}){super(),this.keysExchanged=!1,this.step=e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE,this.debug=!1,this.context=o,this.myECIES=new ze(Object.assign(Object.assign({},i),{debug:null==r?void 0:r.eciesLayer})),this.communicationLayer=t,this.myPublicKey=this.myECIES.getPublicKey(),this.debug=!0===(null==r?void 0:r.keyExchangeLayer),(null==r?void 0:r.keyExchangeLayer)&&L.enable("KeyExchange:Layer"),n&&this.setOtherPublicKey(n),this.communicationLayer.on(rt.KEY_EXCHANGE,this.onKeyExchangeMessage.bind(this))}onKeyExchangeMessage(t){F.KeyExchange(`[KeyExchange: onKeyExchangeMessage()] context=${this.context} keysExchanged=${this.keysExchanged}`,t);const{message:n}=t;this.keysExchanged&&F.KeyExchange(`[KeyExchange: onKeyExchangeMessage()] context=${this.context} received handshake while already exchanged. step=${this.step} otherPubKey=${this.otherPublicKey}`),this.emit(e.EventType.KEY_INFO,n.type),n.type===e.KeyExchangeMessageType.KEY_HANDSHAKE_SYN?(this.checkStep([e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE,e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK]),F.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_SYN",n),n.pubkey&&this.setOtherPublicKey(n.pubkey),this.communicationLayer.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK,pubkey:this.myPublicKey}),this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK)):n.type===e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK?(this.checkStep([e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK,e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK,e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE]),F.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_SYNACK"),n.pubkey&&this.setOtherPublicKey(n.pubkey),this.communicationLayer.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK}),this.keysExchanged=!0,this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK),this.emit(e.EventType.KEYS_EXCHANGED)):n.type===e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK&&(F.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_ACK set keysExchanged to true!"),this.checkStep([e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK,e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE]),this.keysExchanged=!0,this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK),this.emit(e.EventType.KEYS_EXCHANGED))}resetKeys(e){this.clean(),this.myECIES=new ze(e)}clean(){F.KeyExchange(`[KeyExchange: clean()] context=${this.context} reset handshake state`),this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE),this.emit(e.EventType.KEY_INFO,this.step),this.keysExchanged=!1}start({isOriginator:t,force:n}){F.KeyExchange(`[KeyExchange: start()] context=${this.context} isOriginator=${t} step=${this.step} force=${n} keysExchanged=${this.keysExchanged}`),t?!(this.keysExchanged||this.step!==e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE&&this.step!==e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK)||n?(F.KeyExchange(`[KeyExchange: start()] context=${this.context} -- start key exchange (force=${n}) -- step=${this.step}`,this.step),this.clean(),this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK),this.communicationLayer.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_SYN,pubkey:this.myPublicKey})):F.KeyExchange(`[KeyExchange: start()] context=${this.context} -- key exchange already ${this.keysExchanged?"done":"in progress"} -- aborted.`,this.step):this.keysExchanged&&!0!==n?F.KeyExchange("[KeyExchange: start()] don't send KEY_HANDSHAKE_START -- exchange already done."):(this.communicationLayer.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_START}),this.clean())}setStep(t){this.step=t,this.emit(e.EventType.KEY_INFO,t)}checkStep(e){e.length>0&&-1===e.indexOf(this.step.toString())&&console.warn(`[KeyExchange: checkStep()]  Wrong Step "${this.step}" not within ${e}`)}setKeysExchanged(e){this.keysExchanged=e}areKeysExchanged(){return this.keysExchanged}getMyPublicKey(){return this.myPublicKey}getOtherPublicKey(){return this.otherPublicKey}setOtherPublicKey(e){F.KeyExchange("[KeyExchange: setOtherPubKey()]",e),this.otherPublicKey=e}encryptMessage(e){if(!this.otherPublicKey)throw new Error("encryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.encrypt(e,this.otherPublicKey)}decryptMessage(e){if(!this.otherPublicKey)throw new Error("decryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.decrypt(e)}getKeyInfo(){return{ecies:Object.assign(Object.assign({},this.myECIES.getKeyInfo()),{otherPubKey:this.otherPublicKey}),step:this.step,keysExchanged:this.areKeysExchanged()}}toString(){const e={keyInfo:this.getKeyInfo(),keysExchanged:this.keysExchanged,step:this.step};return JSON.stringify(e)}}e.MessageType=void 0,(at=e.MessageType||(e.MessageType={})).TERMINATE="terminate",at.ANSWER="answer",at.OFFER="offer",at.CANDIDATE="candidate",at.JSONRPC="jsonrpc",at.WALLET_INFO="wallet_info",at.ORIGINATOR_INFO="originator_info",at.PAUSE="pause",at.OTP="otp",at.AUTHORIZED="authorized",at.PING="ping",at.READY="ready";const ht=e=>new Promise((t=>{setTimeout(t,e)})),gt=(e,t,n=200)=>r(void 0,void 0,void 0,(function*(){let o;const i=Date.now();let r=!1;for(;!r;){if(r=Date.now()-i>3e5,o=t[e],void 0!==o.elapsedTime)return o;yield ht(n)}throw new Error(`RPC ${e} timed out`)})),ft=({rpcId:e,instance:t})=>r(void 0,void 0,void 0,(function*(){for(;t.state.lastRpcId===e||void 0===t.state.lastRpcId;)yield ht(200);return t.state.lastRpcId})),mt=t=>r(void 0,void 0,void 0,(function*(){var n,o,i,r,s;return F.SocketService(`[SocketService: reconnectSocket()] instance.state.socket?.connected=${null===(n=t.state.socket)||void 0===n?void 0:n.connected} trying to reconnect after socketio disconnection`,t),yield ht(200),(null===(o=t.state.socket)||void 0===o?void 0:o.connected)||(t.state.resumed=!0,null===(i=t.state.socket)||void 0===i||i.connect(),t.emit(e.EventType.SOCKET_RECONNECT),null===(r=t.state.socket)||void 0===r||r.emit(e.EventType.JOIN_CHANNEL,t.state.channelId,`${t.state.context}connect_again`)),yield ht(100),null===(s=t.state.socket)||void 0===s?void 0:s.connected}));function yt(t){return n=>{F.SocketService(`[SocketService: handleDisconnect()] on 'disconnect' manualDisconnect=${t.state.manualDisconnect}`,n),t.state.manualDisconnect||(t.emit(e.EventType.SOCKET_DISCONNECTED),function(e){"undefined"!=typeof window&&"undefined"!=typeof document&&(F.SocketService(`[SocketService: checkFocusAndReconnect()] hasFocus=${document.hasFocus()}`,e),document.hasFocus()?mt(e).then((t=>{F.SocketService(`SocketService::checkFocus reconnectSocket success=${t}`,e)})).catch((e=>{console.error("SocketService::checkFocus Error reconnecting socket",e)})):window.addEventListener("focus",(()=>{mt(e).catch((e=>{console.error("SocketService::checkFocus Error reconnecting socket",e)}))}),{once:!0}))}(t))}}var pt;e.TrackingEvents=void 0,(pt=e.TrackingEvents||(e.TrackingEvents={})).REQUEST="sdk_connect_request_started",pt.REQUEST_MOBILE="sdk_connect_request_started_mobile",pt.RECONNECT="sdk_reconnect_request_started",pt.CONNECTED="sdk_connection_established",pt.CONNECTED_MOBILE="sdk_connection_established_mobile",pt.AUTHORIZED="sdk_connection_authorized",pt.REJECTED="sdk_connection_rejected",pt.TERMINATED="sdk_connection_terminated",pt.DISCONNECTED="sdk_disconnected",pt.SDK_USE_EXTENSION="sdk_use_extension",pt.SDK_RPC_REQUEST="sdk_rpc_request",pt.SDK_RPC_REQUEST_RECEIVED="sdk_rpc_request_received",pt.SDK_RPC_REQUEST_DONE="sdk_rpc_request_done",pt.SDK_EXTENSION_UTILIZED="sdk_extension_utilized",pt.SDK_USE_INAPP_BROWSER="sdk_use_inapp_browser";const vt="SDK_CONNECTION_ISSUE";var Et;!function(e){e.RPC_CHECK="rpcCheck",e.SKIPPED_RPC="skippedRpc"}(Et||(Et={}));const Ct=["eth_sendTransaction","eth_signTypedData","eth_signTransaction","personal_sign","wallet_requestPermissions","wallet_switchEthereumChain","eth_signTypedData_v3","eth_signTypedData_v4","metamask_connectSign","metamask_connectWith","metamask_batch"].map((e=>e.toLowerCase()));function St(t,n){var o,i,s,a;if(!t.state.channelId)throw new Error("Create a channel first");F.SocketService(`[SocketService: handleSendMessage()] context=${t.state.context} areKeysExchanged=${null===(o=t.state.keyExchange)||void 0===o?void 0:o.areKeysExchanged()}`,n);(null===(i=null==n?void 0:n.type)||void 0===i?void 0:i.startsWith("key_handshake"))?function(t,n){var o;F.SocketService(`[SocketService: handleKeyHandshake()] context=${t.state.context}`,n),null===(o=t.state.socket)||void 0===o||o.emit(e.EventType.MESSAGE,{id:t.state.channelId,context:t.state.context,message:n})}(t,n):(!function(e,t){var n;if(!(null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()))throw F.SocketService(`[SocketService: validateKeyExchange()] context=${e.state.context} ERROR keys not exchanged`,t),new Error("Keys not exchanged BBB")}(t,n),function(t,n){var o;const i=null!==(o=null==n?void 0:n.method)&&void 0!==o?o:"",r=null==n?void 0:n.id;t.state.isOriginator&&r&&(t.state.rpcMethodTracker[r]={id:r,timestamp:Date.now(),method:i},t.emit(e.EventType.RPC_UPDATE,t.state.rpcMethodTracker[r]))}(t,n),function(t,n){var o,i;const r=null===(o=t.state.keyExchange)||void 0===o?void 0:o.encryptMessage(JSON.stringify(n)),s={id:t.state.channelId,context:t.state.context,message:r,plaintext:t.state.hasPlaintext?JSON.stringify(n):void 0};F.SocketService(`[SocketService: encryptAndSendMessage()] context=${t.state.context}`,s),n.type===e.MessageType.TERMINATE&&(t.state.manualDisconnect=!0),null===(i=t.state.socket)||void 0===i||i.emit(e.EventType.MESSAGE,s)}(t,n),t.remote.state.analytics&&t.remote.state.isOriginator&&n.method&&Ct.includes(n.method.toLowerCase())&&G({id:null!==(s=t.remote.state.channelId)&&void 0!==s?s:"",event:e.TrackingEvents.SDK_RPC_REQUEST,sdkVersion:t.remote.state.sdkVersion,commLayerVersion:Ve.version,walletVersion:null===(a=t.remote.state.walletInfo)||void 0===a?void 0:a.version,params:{method:n.method,from:"mobile"}},t.remote.state.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)})),function(t,n){var o;return r(this,void 0,void 0,(function*(){const i=null==n?void 0:n.id,s=null!==(o=null==n?void 0:n.method)&&void 0!==o?o:"";if(t.state.isOriginator&&i)try{const o=gt(i,t.state.rpcMethodTracker,200).then((e=>({type:Et.RPC_CHECK,result:e}))),a=(()=>r(this,void 0,void 0,(function*(){const e=yield ft({instance:t,rpcId:i}),n=yield gt(e,t.state.rpcMethodTracker,200);return{type:Et.SKIPPED_RPC,result:n}})))(),c=yield Promise.race([o,a]);if(c.type===Et.RPC_CHECK){const e=c.result;F.SocketService(`[SocketService:handleRpcReplies()] id=${n.id} ${s} ( ${e.elapsedTime} ms)`,e.result)}else{if(c.type!==Et.SKIPPED_RPC)throw new Error(`Error handling RPC replies for ${i}`);{const{result:n}=c;console.warn(`[SocketService handleRpcReplies()] RPC METHOD HAS BEEN SKIPPED rpcid=${i} method=${s}`,n);const o=Object.assign(Object.assign({},t.state.rpcMethodTracker[i]),{error:new Error(vt)});t.emit(e.EventType.RPC_UPDATE,o);const r={data:Object.assign(Object.assign({},o),{jsonrpc:"2.0"}),name:"metamask-provider"};t.emit(e.EventType.MESSAGE,{message:r})}}}catch(e){throw console.warn(`[SocketService handleRpcReplies()] Error rpcId=${n.id} ${s}`,e),e}}))}(t,n).catch((e=>{console.warn("Error handleRpcReplies",e)})))}const kt=[{event:"clients_connected",handler:function(t,n){return o=>r(this,void 0,void 0,(function*(){var o,i,r,s,a,c,u,l;F.SocketService(`[SocketService: handleClientsConnected()] context=${t.state.context} on 'clients_connected-${n}'  resumed=${t.state.resumed}  clientsPaused=${t.state.clientsPaused} keysExchanged=${null===(o=t.state.keyExchange)||void 0===o?void 0:o.areKeysExchanged()} isOriginator=${t.state.isOriginator}`),t.emit(e.EventType.CLIENTS_CONNECTED,{isOriginator:t.state.isOriginator,keysExchanged:null===(i=t.state.keyExchange)||void 0===i?void 0:i.areKeysExchanged(),context:t.state.context}),t.state.resumed?(t.state.isOriginator||(F.SocketService(`[SocketService: handleClientsConnected()] context=${t.state.context} 'clients_connected' / keysExchanged=${null===(r=t.state.keyExchange)||void 0===r?void 0:r.areKeysExchanged()} -- backward compatibility`),null===(s=t.state.keyExchange)||void 0===s||s.start({isOriginator:null!==(a=t.state.isOriginator)&&void 0!==a&&a})),t.state.resumed=!1):t.state.clientsPaused?F.SocketService("[SocketService: handleClientsConnected()] 'clients_connected' skip sending originatorInfo on pause"):t.state.isOriginator||(F.SocketService(`[SocketService: handleClientsConnected()] context=${t.state.context} on 'clients_connected' / keysExchanged=${null===(c=t.state.keyExchange)||void 0===c?void 0:c.areKeysExchanged()} -- backward compatibility`),null===(u=t.state.keyExchange)||void 0===u||u.start({isOriginator:null!==(l=t.state.isOriginator)&&void 0!==l&&l,force:!0})),t.state.clientsConnected=!0,t.state.clientsPaused=!1}))}},{event:"channel_created",handler:function(t,n){return o=>{F.SocketService(`[SocketService: handleChannelCreated()] context=${t.state.context} on 'channel_created-${n}'`,o),t.emit(e.EventType.CHANNEL_CREATED,o)}}},{event:"clients_disconnected",handler:function(t,n){return()=>{var o;t.state.clientsConnected=!1,F.SocketService(`[SocketService: handlesClientsDisconnected()] context=${t.state.context} on 'clients_disconnected-${n}'`),t.state.isOriginator&&!t.state.clientsPaused&&(null===(o=t.state.keyExchange)||void 0===o||o.clean()),t.emit(e.EventType.CLIENTS_DISCONNECTED,n)}}},{event:"message",handler:function(t,n){return({id:o,message:i,error:r})=>{var s,a,c,u,l,d,h,g,f,m,y,p,v,E,C,S,k;if(F.SocketService(`[SocketService handleMessage()] context=${t.state.context} on 'message' ${n} keysExchanged=${null===(s=t.state.keyExchange)||void 0===s?void 0:s.areKeysExchanged()}`,i),r)throw F.SocketService(`\n      [SocketService handleMessage()] context=${t.state.context}::on 'message' error=${r}`),new Error(r);try{!function(e,t){if(t!==e.channelId)throw e.debug&&console.error(`Wrong id ${t} - should be ${e.channelId}`),new Error("Wrong id")}(t.state,o)}catch(e){return void console.error("ignore message --- wrong id ",i)}if(t.state.isOriginator&&(null==i?void 0:i.type)===e.KeyExchangeMessageType.KEY_HANDSHAKE_START)return F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' received HANDSHAKE_START isOriginator=${t.state.isOriginator}`,i),void(null===(a=t.state.keyExchange)||void 0===a||a.start({isOriginator:null!==(c=t.state.isOriginator)&&void 0!==c&&c,force:!0}));if((null==i?void 0:i.type)===e.MessageType.PING)return F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' ping `),void t.emit(e.EventType.MESSAGE,{message:{type:"ping"}});if(F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' originator=${t.state.isOriginator}, type=${null==i?void 0:i.type}, keysExchanged=${null===(u=t.state.keyExchange)||void 0===u?void 0:u.areKeysExchanged()}`),null===(l=null==i?void 0:i.type)||void 0===l?void 0:l.startsWith("key_handshake"))return F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' emit KEY_EXCHANGE`,i),void t.emit(rt.KEY_EXCHANGE,{message:i,context:t.state.context});if(null===(d=t.state.keyExchange)||void 0===d?void 0:d.areKeysExchanged()){if(-1!==i.toString().indexOf("type"))return console.warn("[SocketService handleMessage() ::on 'message' received non encrypted unkwown message"),void t.emit(e.EventType.MESSAGE,i)}else{let n=!1;try{null===(h=t.state.keyExchange)||void 0===h||h.decryptMessage(i),n=!0}catch(e){}if(!n)return t.state.isOriginator?null===(f=t.state.keyExchange)||void 0===f||f.start({isOriginator:null!==(m=t.state.isOriginator)&&void 0!==m&&m}):t.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_START}),void console.warn(`Message ignored because invalid key exchange status. step=${null===(y=t.state.keyExchange)||void 0===y?void 0:y.getKeyInfo().step}`,null===(p=t.state.keyExchange)||void 0===p?void 0:p.getKeyInfo(),i);console.warn("Invalid key exchange status detected --- updating it."),null===(g=t.state.keyExchange)||void 0===g||g.setKeysExchanged(!0)}const T=null===(v=t.state.keyExchange)||void 0===v?void 0:v.decryptMessage(i),x=JSON.parse(null!=T?T:"{}");if((null==x?void 0:x.type)===e.MessageType.PAUSE?t.state.clientsPaused=!0:t.state.clientsPaused=!1,t.state.isOriginator&&x.data){const n=x.data,o=t.state.rpcMethodTracker[n.id];if(o){const i=Date.now()-o.timestamp;F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' received answer for id=${n.id} method=${o.method} responseTime=${i}`,x),t.remote.state.analytics&&Ct.includes(o.method.toLowerCase())&&G({id:null!==(E=t.remote.state.channelId)&&void 0!==E?E:"",event:e.TrackingEvents.SDK_RPC_REQUEST_DONE,sdkVersion:t.remote.state.sdkVersion,commLayerVersion:Ve.version,walletVersion:null===(C=t.remote.state.walletInfo)||void 0===C?void 0:C.version,params:{method:o.method,from:"mobile"}},t.remote.state.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}));const r=Object.assign(Object.assign({},o),{result:n.result,error:n.error?{code:null===(S=n.error)||void 0===S?void 0:S.code,message:null===(k=n.error)||void 0===k?void 0:k.message}:void 0,elapsedTime:i});t.state.rpcMethodTracker[n.id]=r,t.emit(e.EventType.RPC_UPDATE,r)}}t.emit(e.EventType.MESSAGE,{message:x})}}},{event:"clients_waiting_to_join",handler:function(t,n){return o=>{F.SocketService(`[SocketService: handleClientsWaitingToJoin()] context=${t.state.context} on 'clients_waiting_to_join-${n}'`,o),t.emit(e.EventType.CLIENTS_WAITING,o)}}}],Tt=[{event:e.EventType.KEY_INFO,handler:function(t){return n=>{F.SocketService("[SocketService: handleKeyInfo()] on 'KEY_INFO'",n),t.emit(e.EventType.KEY_INFO,n)}}},{event:e.EventType.KEYS_EXCHANGED,handler:function(t){return()=>{var n,o;F.SocketService(`[SocketService: handleKeysExchanged()] on 'keys_exchanged' keyschanged=${null===(n=t.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()}`),t.emit(e.EventType.KEYS_EXCHANGED,{keysExchanged:null===(o=t.state.keyExchange)||void 0===o?void 0:o.areKeysExchanged(),isOriginator:t.state.isOriginator});const i={keyInfo:t.getKeyInfo()};t.emit(e.EventType.SERVICE_STATUS,i)}}}];function xt(e,t){F.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} setting socket listeners for channel ${t}...`);const{socket:n}=e.state,{keyExchange:o}=e.state;e.state.setupChannelListeners&&console.warn(`[SocketService: setupChannelListener()] context=${e.state.context} socket listeners already set up for channel ${t}`),n&&e.state.isOriginator&&(e.state.debug&&(null==n||n.io.on("error",(t=>{F.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=error`,t)})),null==n||n.io.on("reconnect",(t=>{F.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=reconnect`,t)})),null==n||n.io.on("reconnect_error",(t=>{F.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=reconnect_error`,t)})),null==n||n.io.on("reconnect_failed",(()=>{F.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=reconnect_failed`)})),null==n||n.io.on("ping",(()=>{F.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=ping`)}))),null==n||n.on("disconnect",(t=>(F.SocketService(`[SocketService: setupChannelListener()] on 'disconnect' -- MetaMaskSDK socket disconnected '${t}' begin recovery...`),yt(e)(t))))),kt.forEach((({event:o,handler:i})=>{const r=`${o}-${t}`;null==n||n.on(r,i(e,t))})),Tt.forEach((({event:t,handler:n})=>{null==o||o.on(t,n(e))})),e.state.setupChannelListeners=!0}class wt extends o.EventEmitter2{constructor({otherPublicKey:e,reconnect:t,communicationLayerPreference:n,transports:o,communicationServerUrl:r,context:s,ecies:a,remote:c,logging:u}){super(),this.state={clientsConnected:!1,clientsPaused:!1,manualDisconnect:!1,lastRpcId:void 0,rpcMethodTracker:{},hasPlaintext:!1,communicationServerUrl:""},this.state.resumed=t,this.state.context=s,this.state.communicationLayerPreference=n,this.state.debug=!0===(null==u?void 0:u.serviceLayer),this.remote=c,!0===(null==u?void 0:u.serviceLayer)&&L.enable("SocketService:Layer"),this.state.communicationServerUrl=r,this.state.hasPlaintext=this.state.communicationServerUrl!==Ge&&!0===(null==u?void 0:u.plaintext);const l={autoConnect:!1,transports:We,withCredentials:!0};o&&(l.transports=o),F.SocketService(`[SocketService: constructor()] Socket IO url: ${this.state.communicationServerUrl}`),this.state.socket=i.io(r,l);const d={communicationLayer:this,otherPublicKey:e,sendPublicKey:!1,context:this.state.context,ecies:a,logging:u};this.state.keyExchange=new dt(d)}resetKeys(){return e=this,F.SocketService("[SocketService: resetKeys()] Resetting keys."),void(null===(t=e.state.keyExchange)||void 0===t||t.resetKeys());var e,t}createChannel(){return function(t){var n,o,i,r;F.SocketService(`[SocketService: createChannel()] context=${t.state.context}`),(null===(n=t.state.socket)||void 0===n?void 0:n.connected)||null===(o=t.state.socket)||void 0===o||o.connect(),t.state.manualDisconnect=!1,t.state.isOriginator=!0;const s=lt();return t.state.channelId=s,xt(t,s),null===(i=t.state.socket)||void 0===i||i.emit(e.EventType.JOIN_CHANNEL,s,`${t.state.context}createChannel`),{channelId:s,pubKey:(null===(r=t.state.keyExchange)||void 0===r?void 0:r.getMyPublicKey())||""}}(this)}connectToChannel({channelId:t,isOriginator:n=!1,withKeyExchange:o=!1}){return function({options:t,instance:n}){var o,i,r,s;const{channelId:a,withKeyExchange:c,isOriginator:u}=t;if(F.SocketService(`[SocketService: connectToChannel()] context=${n.state.context} channelId=${a} isOriginator=${u}`,null===(o=n.state.keyExchange)||void 0===o?void 0:o.toString()),null===(i=n.state.socket)||void 0===i?void 0:i.connected)throw new Error("socket already connected");n.state.manualDisconnect=!1,null===(r=n.state.socket)||void 0===r||r.connect(),n.state.withKeyExchange=c,n.state.isOriginator=u,n.state.channelId=a,xt(n,a),null===(s=n.state.socket)||void 0===s||s.emit(e.EventType.JOIN_CHANNEL,a,`${n.state.context}_connectToChannel`)}({options:{channelId:t,isOriginator:n,withKeyExchange:o},instance:this})}getKeyInfo(){return this.state.keyExchange.getKeyInfo()}keyCheck(){var t,n;null===(n=(t=this).state.socket)||void 0===n||n.emit(e.EventType.MESSAGE,{id:t.state.channelId,context:t.state.context,message:{type:e.KeyExchangeMessageType.KEY_HANDSHAKE_CHECK,pubkey:t.getKeyInfo().ecies.otherPubKey}})}getKeyExchange(){return this.state.keyExchange}sendMessage(e){return St(this,e)}ping(){return t=this,F.SocketService(`[SocketService: ping()] context=${t.state.context} originator=${t.state.isOriginator} keysExchanged=${null===(n=t.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()}`),t.state.isOriginator&&((null===(o=t.state.keyExchange)||void 0===o?void 0:o.areKeysExchanged())?(console.warn(`[SocketService:ping()] context=${t.state.context} sending READY message`),t.sendMessage({type:e.MessageType.READY})):(console.warn(`[SocketService: ping()] context=${t.state.context} starting key exchange`),null===(i=t.state.keyExchange)||void 0===i||i.start({isOriginator:null!==(r=t.state.isOriginator)&&void 0!==r&&r}))),void(null===(s=t.state.socket)||void 0===s||s.emit(e.EventType.MESSAGE,{id:t.state.channelId,context:t.state.context,message:{type:e.MessageType.PING}}));var t,n,o,i,r,s}pause(){return t=this,F.SocketService(`[SocketService: pause()] context=${t.state.context}`),t.state.manualDisconnect=!0,(null===(n=t.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged())&&t.sendMessage({type:e.MessageType.PAUSE}),void(null===(o=t.state.socket)||void 0===o||o.disconnect());var t,n,o}isConnected(){var e;return null===(e=this.state.socket)||void 0===e?void 0:e.connected}resume(){return t=this,F.SocketService(`[SocketService: resume()] context=${t.state.context} connected=${null===(n=t.state.socket)||void 0===n?void 0:n.connected} manualDisconnect=${t.state.manualDisconnect} resumed=${t.state.resumed} keysExchanged=${null===(o=t.state.keyExchange)||void 0===o?void 0:o.areKeysExchanged()}`),(null===(i=t.state.socket)||void 0===i?void 0:i.connected)?F.SocketService("[SocketService: resume()] already connected."):(null===(r=t.state.socket)||void 0===r||r.connect(),F.SocketService(`[SocketService: resume()] after connecting socket --\x3e connected=${null===(s=t.state.socket)||void 0===s?void 0:s.connected}`),null===(a=t.state.socket)||void 0===a||a.emit(e.EventType.JOIN_CHANNEL,t.state.channelId,`${t.state.context}_resume`)),(null===(c=t.state.keyExchange)||void 0===c?void 0:c.areKeysExchanged())?t.state.isOriginator||t.sendMessage({type:e.MessageType.READY}):t.state.isOriginator||null===(u=t.state.keyExchange)||void 0===u||u.start({isOriginator:null!==(l=t.state.isOriginator)&&void 0!==l&&l}),t.state.manualDisconnect=!1,void(t.state.resumed=!0);var t,n,o,i,r,s,a,c,u,l}getRPCMethodTracker(){return this.state.rpcMethodTracker}disconnect(e){return function(e,t){var n,o;F.SocketService(`[SocketService: disconnect()] context=${e.state.context}`,t),(null==t?void 0:t.terminate)&&(e.state.channelId=t.channelId,null===(n=e.state.keyExchange)||void 0===n||n.clean()),e.state.rpcMethodTracker={},e.state.manualDisconnect=!0,null===(o=e.state.socket)||void 0===o||o.disconnect()}(this,e)}}var _t,At;function It(t){return()=>r(this,void 0,void 0,(function*(){var n,o,i;const{state:s}=t;if(s.authorized)return;yield(()=>r(this,void 0,void 0,(function*(){for(;!s.walletInfo;)yield ht(500)})))();const a="7.3".localeCompare((null===(n=s.walletInfo)||void 0===n?void 0:n.version)||"");if(F.RemoteCommunication(`[RemoteCommunication: handleAuthorizedEvent()] HACK 'authorized' version=${null===(o=s.walletInfo)||void 0===o?void 0:o.version} compareValue=${a}`),1!==a)return;const c=s.platformType===e.PlatformType.MobileWeb||s.platformType===e.PlatformType.ReactNative||s.platformType===e.PlatformType.MetaMaskMobileWebview;F.RemoteCommunication(`[RemoteCommunication: handleAuthorizedEvent()] HACK 'authorized' platform=${s.platformType} secure=${c} channel=${s.channelId} walletVersion=${null===(i=s.walletInfo)||void 0===i?void 0:i.version}`),c&&(s.authorized=!0,t.emit(e.EventType.AUTHORIZED))}))}function Kt(t){return n=>{const{state:o}=t;F.RemoteCommunication(`[RemoteCommunication: handleChannelCreatedEvent()] context=${o.context} on 'channel_created' channelId=${n}`),t.emit(e.EventType.CHANNEL_CREATED,n)}}function Rt(t,n){return()=>{var o,i,r,s;const{state:a}=t;if(F.RemoteCommunication(`[RemoteCommunication: handleClientsConnectedEvent()] on 'clients_connected' channel=${a.channelId} keysExchanged=${null===(i=null===(o=a.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.keysExchanged}`),a.analytics){const t=a.isOriginator?e.TrackingEvents.REQUEST:e.TrackingEvents.REQUEST_MOBILE;G(Object.assign(Object.assign({id:null!==(r=a.channelId)&&void 0!==r?r:"",event:a.reconnection?e.TrackingEvents.RECONNECT:t},a.originatorInfo),{commLayer:n,sdkVersion:a.sdkVersion,walletVersion:null===(s=a.walletInfo)||void 0===s?void 0:s.version,commLayerVersion:Ve.version}),a.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}))}a.clientsConnected=!0,a.originatorInfoSent=!1,t.emit(e.EventType.CLIENTS_CONNECTED)}}function bt(t,n){return o=>{var i;const{state:r}=t;F.RemoteCommunication(`[RemoteCommunication: handleClientsDisconnectedEvent()] context=${r.context} on 'clients_disconnected' channelId=${o}`),r.clientsConnected=!1,t.emit(e.EventType.CLIENTS_DISCONNECTED,r.channelId),t.setConnectionStatus(e.ConnectionStatus.DISCONNECTED),r.ready=!1,r.authorized=!1,r.analytics&&r.channelId&&G({id:r.channelId,event:e.TrackingEvents.DISCONNECTED,sdkVersion:r.sdkVersion,commLayer:n,commLayerVersion:Ve.version,walletVersion:null===(i=r.walletInfo)||void 0===i?void 0:i.version},r.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}))}}function Nt(t){return n=>{var o;const{state:i}=t;if(F.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] context=${i.context} on 'clients_waiting' numberUsers=${n} ready=${i.ready} autoStarted=${i.originatorConnectStarted}`),t.setConnectionStatus(e.ConnectionStatus.WAITING),t.emit(e.EventType.CLIENTS_WAITING,n),i.originatorConnectStarted){F.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] on 'clients_waiting' watch autoStarted=${i.originatorConnectStarted} timeout`,i.autoConnectOptions);const n=(null===(o=i.autoConnectOptions)||void 0===o?void 0:o.timeout)||3e3,r=setTimeout((()=>{F.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] setTimeout(${n}) terminate channelConfig`,i.autoConnectOptions),i.originatorConnectStarted=!1,i.ready||t.setConnectionStatus(e.ConnectionStatus.TIMEOUT),clearTimeout(r)}),n)}}}function Ot(t,n){return o=>{var i,r,s,a,c;const{state:u}=t;F.RemoteCommunication(`[RemoteCommunication: handleKeysExchangedEvent()] context=${u.context} on commLayer.'keys_exchanged' channel=${u.channelId}`,o),(null===(r=null===(i=u.communicationLayer)||void 0===i?void 0:i.getKeyInfo())||void 0===r?void 0:r.keysExchanged)&&t.setConnectionStatus(e.ConnectionStatus.LINKED),function(e,t){var n,o,i,r;const{state:s}=e;F.RemoteCommunication(`[RemoteCommunication: setLastActiveDate()] channel=${s.channelId}`,t);const a={channelId:null!==(n=s.channelId)&&void 0!==n?n:"",validUntil:null!==(i=null===(o=s.channelConfig)||void 0===o?void 0:o.validUntil)&&void 0!==i?i:0,lastActive:t.getTime()};null===(r=s.storageManager)||void 0===r||r.persistChannelConfig(a)}(t,new Date),u.analytics&&u.channelId&&G({id:u.channelId,event:o.isOriginator?e.TrackingEvents.CONNECTED:e.TrackingEvents.CONNECTED_MOBILE,sdkVersion:u.sdkVersion,commLayer:n,commLayerVersion:Ve.version,walletVersion:null===(s=u.walletInfo)||void 0===s?void 0:s.version},u.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)})),u.isOriginator=o.isOriginator,o.isOriginator||(null===(a=u.communicationLayer)||void 0===a||a.sendMessage({type:e.MessageType.READY}),u.ready=!0,u.paused=!1),o.isOriginator&&!u.originatorInfoSent&&(null===(c=u.communicationLayer)||void 0===c||c.sendMessage({type:e.MessageType.ORIGINATOR_INFO,originatorInfo:u.originatorInfo,originator:u.originatorInfo}),u.originatorInfoSent=!0)}}function Mt(t,n){const{state:o}=n;if(F.RemoteCommunication(`[RemoteCommunication: onCommunicationLayerMessage()] context=${o.context} on 'message' typeof=${typeof t}`,t),n.state.ready=!0,o.isOriginator||t.type!==e.MessageType.ORIGINATOR_INFO)if(o.isOriginator&&t.type===e.MessageType.WALLET_INFO)!function(e,t){const{state:n}=e;n.walletInfo=t.walletInfo,n.paused=!1}(n,t);else{if(t.type===e.MessageType.TERMINATE)!function(t){const{state:n}=t;n.isOriginator&&(Ut({options:{terminate:!0,sendMessage:!1},instance:t}),console.debug(),t.emit(e.EventType.TERMINATE))}(n);else if(t.type===e.MessageType.PAUSE)!function(t){const{state:n}=t;n.paused=!0,t.setConnectionStatus(e.ConnectionStatus.PAUSED)}(n);else if(t.type===e.MessageType.READY&&o.isOriginator)!function(t){const{state:n}=t;t.setConnectionStatus(e.ConnectionStatus.LINKED);const o=n.paused;n.paused=!1,t.emit(e.EventType.CLIENTS_READY,{isOriginator:n.isOriginator,walletInfo:n.walletInfo}),o&&(n.authorized=!0,t.emit(e.EventType.AUTHORIZED))}(n);else{if(t.type===e.MessageType.OTP&&o.isOriginator)return void function(t,n){var o;const{state:i}=t;t.emit(e.EventType.OTP,n.otpAnswer),1==="6.6".localeCompare((null===(o=i.walletInfo)||void 0===o?void 0:o.version)||"")&&(console.warn("RemoteCommunication::on 'otp' -- backward compatibility <6.6 -- triger eth_requestAccounts"),t.emit(e.EventType.SDK_RPC_CALL,{method:qe.ETH_REQUESTACCOUNTS,params:[]}))}(n,t);t.type===e.MessageType.AUTHORIZED&&o.isOriginator&&function(t){const{state:n}=t;n.authorized=!0,t.emit(e.EventType.AUTHORIZED)}(n)}n.emit(e.EventType.MESSAGE,t)}else!function(t,n){var o;const{state:i}=t;null===(o=i.communicationLayer)||void 0===o||o.sendMessage({type:e.MessageType.WALLET_INFO,walletInfo:i.walletInfo}),i.originatorInfo=n.originatorInfo||n.originator,t.emit(e.EventType.CLIENTS_READY,{isOriginator:i.isOriginator,originatorInfo:i.originatorInfo}),i.paused=!1}(n,t)}function Dt(t,n){var o,i;return r(this,void 0,void 0,(function*(){const{state:s}=t;F.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${s.context} paused=${s.paused} ready=${s.ready} authorized=${s.authorized} socket=${null===(o=s.communicationLayer)||void 0===o?void 0:o.isConnected()} clientsConnected=${s.clientsConnected} status=${s._connectionStatus}`,n),!s.paused&&s.ready&&(null===(i=s.communicationLayer)||void 0===i?void 0:i.isConnected())&&s.clientsConnected||(F.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${s.context}  SKIP message waiting for MM mobile readiness.`),yield new Promise((n=>{t.once(e.EventType.CLIENTS_READY,n)})),F.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${s.context}  AFTER SKIP / READY -- sending pending message`));try{yield function(t,n){return r(this,void 0,void 0,(function*(){return new Promise((o=>{var i,r,s,a;const{state:c}=t;if(F.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] context=${c.context} ready=${c.ready} authorized=${c.authorized} method=${n.method}`),1==="7.3".localeCompare((null===(i=c.walletInfo)||void 0===i?void 0:i.version)||""))return F.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] compatibility hack wallet version > ${null===(r=c.walletInfo)||void 0===r?void 0:r.version}`),null===(s=c.communicationLayer)||void 0===s||s.sendMessage(n),void o();!c.isOriginator||c.authorized?(null===(a=c.communicationLayer)||void 0===a||a.sendMessage(n),o()):t.once(e.EventType.AUTHORIZED,(()=>{var e;F.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] context=${c.context}  AFTER SKIP / AUTHORIZED -- sending pending message`),null===(e=c.communicationLayer)||void 0===e||e.sendMessage(n),o()}))}))}))}(t,n)}catch(e){throw console.error(`[RemoteCommunication: sendMessage()] context=${s.context}  ERROR`,e),e}}))}function Pt(e){return t=>{let n=t;t.message&&(n=n.message),Mt(n,e)}}function Lt(e){return()=>{const{state:t}=e;F.RemoteCommunication("[RemoteCommunication: handleSocketReconnectEvent()] on 'socket_reconnect' -- reset key exchange status / set ready to false"),t.ready=!1,t.authorized=!1,Ze(t),e.emitServiceStatusEvent()}}function $t(e){return()=>{const{state:t}=e;F.RemoteCommunication("[RemoteCommunication: handleSocketDisconnectedEvent()] on 'socket_Disconnected' set ready to false"),t.ready=!1}}function Ut({options:t,instance:n}){var o,i,r,s,a,c;const{state:u}=n;F.RemoteCommunication(`[RemoteCommunication: disconnect()] channel=${u.channelId}`,t),u.ready=!1,u.paused=!1,(null==t?void 0:t.terminate)?(null===(o=u.storageManager)||void 0===o||o.terminate(null!==(i=u.channelId)&&void 0!==i?i:""),(null===(r=u.communicationLayer)||void 0===r?void 0:r.getKeyInfo().keysExchanged)&&(null==t?void 0:t.sendMessage)&&(null===(s=u.communicationLayer)||void 0===s||s.sendMessage({type:e.MessageType.TERMINATE})),u.channelId=lt(),t.channelId=u.channelId,u.channelConfig=void 0,u.originatorConnectStarted=!1,null===(a=u.communicationLayer)||void 0===a||a.disconnect(t),n.setConnectionStatus(e.ConnectionStatus.TERMINATED)):(null===(c=u.communicationLayer)||void 0===c||c.disconnect(t),n.setConnectionStatus(e.ConnectionStatus.DISCONNECTED))}e.CommunicationLayerPreference=void 0,(e.CommunicationLayerPreference||(e.CommunicationLayerPreference={})).SOCKET="socket",e.PlatformType=void 0,(_t=e.PlatformType||(e.PlatformType={})).NonBrowser="nodejs",_t.MetaMaskMobileWebview="in-app-browser",_t.DesktopWeb="web-desktop",_t.MobileWeb="web-mobile",_t.ReactNative="react-native";class Ht extends o.EventEmitter2{constructor({platformType:t,communicationLayerPreference:n,otherPublicKey:o,reconnect:i,walletInfo:r,dappMetadata:s,transports:a,context:c,ecies:u,analytics:l=!1,storage:d,sdkVersion:h,communicationServerUrl:g=Ge,logging:f,autoConnect:m={timeout:3e3}}){super(),this.state={ready:!1,authorized:!1,isOriginator:!1,paused:!1,platformType:"metamask-mobile",analytics:!1,reconnection:!1,originatorInfoSent:!1,communicationServerUrl:Ge,context:"",clientsConnected:!1,sessionDuration:Je,originatorConnectStarted:!1,debug:!1,_connectionStatus:e.ConnectionStatus.DISCONNECTED},this.state.otherPublicKey=o,this.state.dappMetadata=s,this.state.walletInfo=r,this.state.transports=a,this.state.platformType=t,this.state.analytics=l,this.state.isOriginator=!o,this.state.communicationServerUrl=g,this.state.context=c,this.state.sdkVersion=h,this.setMaxListeners(50),this.setConnectionStatus(e.ConnectionStatus.DISCONNECTED),(null==d?void 0:d.duration)&&(this.state.sessionDuration=Je),this.state.storageOptions=d,this.state.autoConnectOptions=m,this.state.debug=!0===(null==f?void 0:f.remoteLayer),!0===(null==f?void 0:f.remoteLayer)&&L.enable("RemoteCommunication:Layer"),this.state.logging=f,(null==d?void 0:d.storageManager)&&(this.state.storageManager=d.storageManager),this.initCommunicationLayer({communicationLayerPreference:n,otherPublicKey:o,reconnect:i,ecies:u,communicationServerUrl:g}),this.emitServiceStatusEvent()}initCommunicationLayer({communicationLayerPreference:t,otherPublicKey:n,reconnect:o,ecies:i,communicationServerUrl:r=Ge}){return function({communicationLayerPreference:t,otherPublicKey:n,reconnect:o,ecies:i,communicationServerUrl:r=Ge,instance:s}){var a,c,u,l,d,h,g,f,m;const{state:y}=s;if(t!==e.CommunicationLayerPreference.SOCKET)throw new Error("Invalid communication protocol");y.communicationLayer=new wt({communicationLayerPreference:t,otherPublicKey:n,reconnect:o,transports:y.transports,communicationServerUrl:r,context:y.context,ecies:i,logging:y.logging,remote:s});let p="undefined"!=typeof document&&document.URL||"",v="undefined"!=typeof document&&document.title||"";(null===(a=y.dappMetadata)||void 0===a?void 0:a.url)&&(p=y.dappMetadata.url),(null===(c=y.dappMetadata)||void 0===c?void 0:c.name)&&(v=y.dappMetadata.name);const E={url:p,title:v,source:null===(u=y.dappMetadata)||void 0===u?void 0:u.source,dappId:"undefined"==typeof window?null!==(g=null!==(d=null===(l=y.dappMetadata)||void 0===l?void 0:l.name)&&void 0!==d?d:null===(h=y.dappMetadata)||void 0===h?void 0:h.url)&&void 0!==g?g:"unkown":window.location.hostname,icon:(null===(f=y.dappMetadata)||void 0===f?void 0:f.iconUrl)||(null===(m=y.dappMetadata)||void 0===m?void 0:m.base64Icon),platform:y.platformType,apiVersion:Ve.version};y.originatorInfo=E;const C={[e.EventType.AUTHORIZED]:It(s),[e.EventType.MESSAGE]:Pt(s),[e.EventType.CLIENTS_CONNECTED]:Rt(s,t),[e.EventType.KEYS_EXCHANGED]:Ot(s,t),[e.EventType.SOCKET_DISCONNECTED]:$t(s),[e.EventType.SOCKET_RECONNECT]:Lt(s),[e.EventType.CLIENTS_DISCONNECTED]:bt(s,t),[e.EventType.KEY_INFO]:()=>{s.emitServiceStatusEvent()},[e.EventType.CHANNEL_CREATED]:Kt(s),[e.EventType.CLIENTS_WAITING]:Nt(s),[e.EventType.RPC_UPDATE]:t=>{s.emit(e.EventType.RPC_UPDATE,t)}};for(const[e,t]of Object.entries(C))try{y.communicationLayer.on(e,t)}catch(t){console.error(`Error registering handler for ${e}:`,t)}}({communicationLayerPreference:t,otherPublicKey:n,reconnect:o,ecies:i,communicationServerUrl:r,instance:this})}originatorSessionConnect(){return r(this,void 0,void 0,(function*(){return yield function(e){var t,n,o;return r(this,void 0,void 0,(function*(){const{state:i}=e;if(!i.storageManager)return void F.RemoteCommunication("[RemoteCommunication: originatorSessionConnect()] no storage manager defined - skip");const r=yield i.storageManager.getPersistedChannelConfig(null!==(t=i.channelId)&&void 0!==t?t:"");if(F.RemoteCommunication(`[RemoteCommunication: originatorSessionConnect()] autoStarted=${i.originatorConnectStarted} channelConfig`,r),null===(n=i.communicationLayer)||void 0===n?void 0:n.isConnected())return F.RemoteCommunication("[RemoteCommunication: originatorSessionConnect()] socket already connected - skip"),r;if(r){if(r.validUntil>Date.now())return i.channelConfig=r,i.originatorConnectStarted=!0,i.channelId=null==r?void 0:r.channelId,i.reconnection=!0,null===(o=i.communicationLayer)||void 0===o||o.connectToChannel({channelId:r.channelId,isOriginator:!0}),r;F.RemoteCommunication("[RemoteCommunication: autoConnect()] Session has expired")}i.originatorConnectStarted=!1}))}(this)}))}generateChannelIdConnect(){return r(this,void 0,void 0,(function*(){return function(e){var t,n,o,i,r;if(!e.communicationLayer)throw new Error("communication layer not initialized");if(e.ready)throw new Error("Channel already connected");if(e.channelId&&(null===(t=e.communicationLayer)||void 0===t?void 0:t.isConnected()))return console.warn("Channel already exists -- interrupt generateChannelId",e.channelConfig),e.channelConfig={channelId:e.channelId,validUntil:Date.now()+e.sessionDuration},null===(n=e.storageManager)||void 0===n||n.persistChannelConfig(e.channelConfig),{channelId:e.channelId,pubKey:null===(i=null===(o=e.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.ecies.public};F.RemoteCommunication("[RemoteCommunication: generateChannelId()]"),Ze(e);const s=e.communicationLayer.createChannel();F.RemoteCommunication("[RemoteCommunication: generateChannelId()] channel created",s);const a={channelId:s.channelId,validUntil:Date.now()+e.sessionDuration};return e.channelId=s.channelId,e.channelConfig=a,null===(r=e.storageManager)||void 0===r||r.persistChannelConfig(a),{channelId:e.channelId,pubKey:s.pubKey}}(this.state)}))}clean(){return Ze(this.state)}connectToChannel(e,t){return function({channelId:e,withKeyExchange:t,state:n}){var o,i,r;if(!nt(e))throw F.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${n.context} invalid channel channelId=${e}`),new Error(`Invalid channel ${e}`);if(F.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${n.context} channelId=${e}`),null===(o=n.communicationLayer)||void 0===o?void 0:o.isConnected())return void F.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${n.context} already connected - interrupt connection.`);n.channelId=e,null===(i=n.communicationLayer)||void 0===i||i.connectToChannel({channelId:e,withKeyExchange:t});const s={channelId:e,validUntil:Date.now()+n.sessionDuration};n.channelConfig=s,null===(r=n.storageManager)||void 0===r||r.persistChannelConfig(s)}({channelId:e,withKeyExchange:t,state:this.state})}sendMessage(e){return Dt(this,e)}testStorage(){return r(this,void 0,void 0,(function*(){return function(e){var t,n;return r(this,void 0,void 0,(function*(){const o=yield null===(t=e.storageManager)||void 0===t?void 0:t.getPersistedChannelConfig(null!==(n=e.channelId)&&void 0!==n?n:"");F.RemoteCommunication("[RemoteCommunication: testStorage()] res",o)}))}(this.state)}))}getChannelConfig(){return this.state.channelConfig}isReady(){return this.state.ready}isConnected(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.isConnected()}isAuthorized(){return this.state.authorized}isPaused(){return this.state.paused}getCommunicationLayer(){return this.state.communicationLayer}ping(){var e;F.RemoteCommunication(`[RemoteCommunication: ping()] channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.ping()}keyCheck(){var e;F.RemoteCommunication(`[RemoteCommunication: keyCheck()] channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.keyCheck()}setConnectionStatus(t){this.state._connectionStatus!==t&&(this.state._connectionStatus=t,this.emit(e.EventType.CONNECTION_STATUS,t),this.emitServiceStatusEvent())}emitServiceStatusEvent(){this.emit(e.EventType.SERVICE_STATUS,this.getServiceStatus())}getConnectionStatus(){return this.state._connectionStatus}getServiceStatus(){return{originatorInfo:this.state.originatorInfo,keyInfo:this.getKeyInfo(),connectionStatus:this.state._connectionStatus,channelConfig:this.state.channelConfig,channelId:this.state.channelId}}getKeyInfo(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getKeyInfo()}resetKeys(){var e;null===(e=this.state.communicationLayer)||void 0===e||e.resetKeys()}setOtherPublicKey(e){var t;const n=null===(t=this.state.communicationLayer)||void 0===t?void 0:t.getKeyExchange();if(!n)throw new Error("KeyExchange is not initialized.");n.getOtherPublicKey()!==e&&n.setOtherPublicKey(e)}pause(){var t;F.RemoteCommunication(`[RemoteCommunication: pause()] channel=${this.state.channelId}`),null===(t=this.state.communicationLayer)||void 0===t||t.pause(),this.setConnectionStatus(e.ConnectionStatus.PAUSED)}getVersion(){return Ve.version}resume(){return function(t){var n;const{state:o}=t;F.RemoteCommunication(`[RemoteCommunication: resume()] channel=${o.channelId}`),null===(n=o.communicationLayer)||void 0===n||n.resume(),t.setConnectionStatus(e.ConnectionStatus.LINKED)}(this)}getChannelId(){return this.state.channelId}getRPCMethodTracker(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getRPCMethodTracker()}disconnect(e){return Ut({options:e,instance:this})}}e.AutoConnectType=void 0,(At=e.AutoConnectType||(e.AutoConnectType={})).RENEW="renew",At.LINK="link",e.DEFAULT_SERVER_URL=Ge,e.ECIES=ze,e.RemoteCommunication=Ht,e.SendAnalytics=G,e.SocketService=wt}));
//# sourceMappingURL=metamask-sdk-communication-layer.js.map
